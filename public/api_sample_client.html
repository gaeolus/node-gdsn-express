<!DOCTYPE html>
<html>
<head>
  <!-- Version $URL: http://svn.instill.com/repos/instill_dev/Catalog_Services/node-api-server/trunk/public/api_sample_client.html $ -->
  <meta charset="utf-8">
  <title>CS API Sample Web Client</title>
  <link rel="stylesheet" href="/css/styles.css">
</head>
<body>

<h2>Fetch Subscribed Items</h2>

<div>
<table><tr><td>
    <p>Server (host and port)<br/><input id="input_server" value="plt-gdsn02.itradenetwork.com:8080" size="40"></input></p>
    <p>GTIN<br/><input id="input_gtin" value="00038000105234" size="40"></input></p>
    <p>Provider GLN<br/><input id="input_provider" value="1100001011292" size="40"></input></p>
    <p>Target Market Country Code<br/><input id="input_tm" value="" size="40"></input></p>
    <p>Target Market Subdivision Code<br/><input id="input_tm_sub" value="" size="40"></input></p>
  </td>
  <td>
    <p>Data Transform <select name="trans_type" id="input_server_transform"><option value="">None</option><option value="client">Client</option><option value="server">Server</option></select></p>
    <p><input id="input_include_children" type="checkbox"></input>  Include Children</p>
    <p><input id="input_include_parents" type="checkbox"></input>   Include Parents</p>
    <p><input id="input_multi_gtin" type="checkbox"></input>        Multi: allow multiple items with same GTIN</p>
    <p><button id="btn_fetch">Fetch Items</button> <span id="fetch_time"></span></p>
    <p><button id="btn_fetch_hide">Clear Results</button></p>
  </td></tr>
</table>
</div>

<div id="results"></div>

<script src="js/jp-pretty-print-101.js"></script>
<script src="js/jquery-1.10.2.js"></script>
<script src="js/bp_cs_client.js"></script>
<script>
$(function () {

  var $results = $('#results')
  $results.hide()

  var log = function (msg) {
    if (console && console.log) console.log(msg)
    else alert(msg)
  }

  var fetchData = function (cb) {
    var gtin = $('#input_gtin').val()
    if (!gtin) return alert('GTIN is required')

    var provider  = $('#input_provider').val()
    var tm        = $('#input_tm').val()
    var tm_sub    = $('#input_tm_sub').val()
    var transform = $('#input_server_transform').val()
    log('transform param: ' + transform)
    var children  = $('#input_include_children').prop('checked')
    var parents   = $('#input_include_parents').prop('checked')
    var multi     = $('#input_multi_gtin').prop('checked')

    var server = $('#input_server').val()
    server = server || 'plt-gdsn02.itradenetwork.com:8080'
    log('server: ' + server)

    var url = 'http://' + server + '/cs_api/1.0/subscribed/' + gtin
    if (provider) url += '/' + provider
    if (tm)       url += '/' + tm
    if (tm_sub)   url += '/' + tm_sub
    log('url: ' + url)

    $.ajax({
      url: url
      , dataType: 'jsonp'
      , accepts: 'application/json'
      , headers: { Authorization: 'Basic YnBfY3BzOmJwX2Nwc0FkbWlu' } // bp_cps / bp_cpsAdmin
      , data: { 
          children: children,
          parents: parents,
          multi: multi,
          transform: transform
        }
    })
    .done(function (data) {
      log('ajax success')
      cb(data, transform)
    })
    .fail(function (xhr, msg, error) {
      log('ajax fail')
      log(arguments)
      alert('Fecth items failed: ' + msg)
    })
  }

  $('#btn_fetch_hide').on('click', function () {
    $results.hide()
  })

  $('#btn_fetch').on('click', function () {
    $results.show().html('Loading...')
    fetchData(function (data, trans) {
      console.log('trans: ' + trans)
      $results.empty()
      if(typeof data == 'string') {
        $results.append('<p>' + data + '</p>')
        return
      }
      if (data.collection.error) {
        var e = data.collection.error
        $results.append('<p>Error: ' + e.title + ' (' + e.message + ')</p>')
        if (data.collection.links) {
          var links = data.collection.links
          if (links.length) $results.append('<p>Please specify more criteria as shown below:</p>')
          links.forEach(function (link) {
            $results.append('<p><a target="new" href="' + link.href + '">' + link.href + '</a></p>')
          })
        }
        return
      }
      var items = data.collection.items || []
      items.forEach(function (item) {
        if (trans == 'client') item = cs_client.transform(item)
        log('appending item ' + item.gtin)
        $results.append('<br/><span>Item ' + item.href + ' (' + item.fetch_type + '):</span>')
        $results.append('<br/><textarea rows="6" cols="120">' + JSON.stringify(item) + '</textarea>')
      })
    })
  })

})
</script>

</body>
</html>
