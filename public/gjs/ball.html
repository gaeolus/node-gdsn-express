<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>CS Data View</title>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
  <style>
    table {
      background-color: #fcfcfc;
      border-collapse: collapse;
    }
    table, th, td {
      border: 1px solid #e1e1e1;
      padding: 6px;
    }
   </style>
</head>
<body>
<h2>Data:</h2>  
</body>
<script src="./Three.js"></script>
<script src="./ammo.js"></script>
<script src="./physi.js"></script>
<script src="./physijs_worker.js"></script>

<script>
  // workaround for chrome bug:
  // http://code.google.com/p/chromium/issues/detail?id=35980#c12
  if (window.innerWidth === 0) {
    window.innerWidth = parent.innerWidth;
    window.innerHeight = parent.innerHeight;
  }

  var scene = new Physijs.Scene({ fixedTimeStep: 2 / 60 });
  scene.setGravity(new THREE.Vector3( 0, -300, 0 ));

  var camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 1, 10000);

  camera.position.set(0, 100, 200); //.z = 500;
  camera.rotation.x = -Math.PI/8;
  scene.add(camera);

  // This will draw what the camera sees onto the screen:
  //var renderer = new THREE.CanvasRenderer();
  var renderer = new THREE.WebGLRenderer();
  renderer.shadowMapEnabled = true;
  renderer.setSize(window.innerWidth, window.innerHeight);
  
  document.body.appendChild(renderer.domElement);
  document.body.style.backgroundColor = '#1133ff';

  // add lights
  scene.add(new THREE.AmbientLight(0x999999));
  
  var back_light = new THREE.PointLight(0xffffff);
  back_light.position.set(50, 50, -100);
  scene.add(back_light);
  
  var spot_light = new THREE.SpotLight(0xffffff);
  spot_light.position.set(-250, 250, 250);
  spot_light.castShadow = true;
  scene.add(spot_light);

  // add ball
  var ball = new Physijs.SphereMesh(
    new THREE.SphereGeometry(50, 25, 21),
    new THREE.MeshPhongMaterial({
      color:     0x333333,
      shininess: 100.0,
      ambient:   0xff0000,
      emissive:  0x111111,
      specular:  0xbbbbbb
    })
  );
  ball.castShadow = true;
  scene.add(ball)
  resetBall(ball)
  
  var board_material = new THREE.MeshPhongMaterial({
      color:     0x333333,
      shininess: 40.0,
      ambient:   0xffd700,
      emissive:  0x111111,
      specular:  0xeeeeee
  });
  
  var board = new Physijs.BoxMesh(
    new THREE.CubeGeometry(200, 2, 200),
    board_material,
    0
  );
  board.position.set(-37, 0, 0);
  board.receiveShadow = true;
  
  board.rotation.set(0.1, 0.1, -0.1);
  scene.add(board)

  document.addEventListener('keydown', function (e) {
    //console.log('key: ' + e.keyCode)
    switch (e.keyCode) {
      case 37: tiltBoard('z',  0.02); break;
      case 39: tiltBoard('z', -0.02); break;
      case 40: tiltBoard('x',  0.02); break;
      case 38: tiltBoard('x', -0.02); break;
      case 32: resetBall(ball); break;
    }
  });

  function tiltBoard(dir, amount) {
    board.__dirtyRotation = true;
    board.rotation[dir] += amount
  }
  
  function resetBall(ball) {
    ball.__dirtyPosition = true;
    ball.position.set(-33, 100, -65);
    ball.setLinearVelocity(0, 0, 0);
    ball.setAngularVelocity(0, 0, 0);
  }

  function animate() {
    requestAnimationFrame(animate);
    //scene.simulate();
    renderer.render(scene, camera);
  }
  animate();

  function gameStep() {
    if (ball.position.y < -150) resetBall(ball);
    scene.simulate();
    setTimeout(gameStep, 1000/30);
  }
  gameStep();
</script>
 

