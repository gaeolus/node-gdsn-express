<!DOCTYPE html>
<html lang="us">
<head>
  <!-- Version $URL: http://svn.instill.com/repos/instill_dev/Catalog_Services/node-api-server/trunk/public/index.html $ -->
  <meta charset="utf-8">
  <title>Catalog Services Dashboard</title>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
  <link rel="stylesheet" href="css/styles_new.css" />
  <link rel="stylesheet" href="jqui/jquery-ui-1.10.4.custom.css" />

  <style type="text/css">
    .clickable { 
      cursor: pointer; 
      border: #ccc dotted 1px; 
    }
    .selected {
      border: #ccf solid 1px; 
    }
    .centered {
      text-align: center;
    }
    td {
      text-align: center;
    }
  </style>

  <style type="text/css">
    #progressbar .ui-progressbar-value {
      background-color:#ccf;
    }
    p.vert_spacer {
        height:20px
    }
    div.blue_box {
      border-style: solid;
      border-width: 1px;
      border-color: blue;
      font-family: sans-serif;
      color: blue;
    }
  </style>

  <script src="js/jp-pretty-print-101.js"></script>
  <script src="js/jquery-1.10.2.js"></script>
  <script src="jqui/jquery-ui-1.10.4.custom.js"></script>
  <script src="js/underscore-1.5.2.js"></script>
  <script src="js/angular-1.2.2.js"></script>
  <script src="js/file/angular-file-upload.js"></script>
  <script src="js/bp_cs_client.js"></script>

  <script src="three_view/js/three_r68.js"></script>
  <script src="three_view/js/controls/OrbitControls.js"></script>
  <!--
  <script src="three_view/js/Detector.js"></script>
  <script src="three_view/js/stats.js"></script>
  -->
  <script src="three_view/js/three_item_view.js"></script>

  
</head>
<body ng-app="thx_app">

<script type="text/ng-template" id="gdsn_sub_list_template.html">
  <div style="border-style:solid;border-width:1px;border-color:blue">
    <div>GDSN Widget</div>
    <div ng-if="data" style="border-style:solid;border-width:1px;border-color:green">
      <div ng-if="selectedSub"><textarea rows="6" cols="60" disabled ng-bind="selectedSub"></textarea></div>
      <div>Subscriptions for subscriber {{data.subscriber}} as of <span ng-bind="timestamp"/>:</div>
      <div class="clickable" ng-repeat="sub in data.subscriptions" ng-click="selectSubscription(sub)">
        <span>{{$index + 1}}. Publisher/Data Source: {{sub.dsName}} (GLN {{sub.ds}})</span>
      </div>
      <div>Data URL: <a ng-href="{{data.url}}">{{data.url}}</a></div>
      <div>Timestamp: <span>{{timestamp}}</span></div>
    </div>
    <div>thx_controller_test: <span>{{thx_controller_test}}</span></div>
    <div>dir_controller_test: <span>{{dir_controller_test}}</span></div>
    <div>dir_link_test: <span>{{dir_link_test}}</span></div>
  </div>
</script>

<div id="tabs">

  <div>
    <h2>Catalog Services Dashboard</h2>
    <!-- Version $URL: http://svn.instill.com/repos/instill_dev/Catalog_Services/node-api-server/trunk/public/index.html $ -->
    <span id="google_link"><a ng-href="/auth/google">Login with Google</a></span>
  </div>

  <ul>
    <li><a href="#main_menu">Main Menu</a></li>
    <li><a href="#msg_tab">Messages</a></li>
    <li><a href="#party_tab">Trading Parties</a></li>
    <li><a href="#item_tab">Catalog Items</a></li>
    <li><a href="#pub_tab">Publication</a></li>
    <li><a href="#sub_tab">Subscription</a></li>
  </ul>

  <div id="main_menu">
    <div id="main_menu-quicklinks">
      <h2>Welcome to Catalog Services</h2>
      <h3>Quick Links</h3>

      <h4>Sample Web Client</h4>
      <p><a href="/api_sample_client.html" target="_blank">Sample API Test Client</a></p>

      <h4>API Docs</h4>
      <p><a href="/cs_api/1.0/login"           target="_blank">Login Endpoint Docs</a></p>
      <p><a href="/cs_api/1.0/items"           target="_blank">Items Endpoint Docs</a></p>
      <p><a href="/cs_api/1.0/subscribed"      target="_blank">Subscriber Endpoint Docs</a></p>
      <p><a href="/cs_api/1.0/lookup_allergens" target="_blank">Allergen Code Lookup Endpoint Docs</a></p>
      <p><a href="/cs_api/1.0/lookup_countries"  target="_blank">Country Code Lookup Endpoint Docs</a></p>
      <p><a href="/cs_api/1.0/lookup_nutrients" target="_blank">Nutrient Code Lookup Endpoint Docs</a></p>

      <h4>Examples</h4>
      <p>(Login: test / testAdmin)</p>
      <p>(Login: bp_cps / bp_cpsAdmin)</p>
      <p><a href="/cs_api/1.0/login?user=test&pass=testAdmin"      target="_blank">Login Endpoint Example: test/testAdmin</a></p>
      <p><a href="/cs_api/1.0/items?xml_text=uniformRes&json=true" target="_blank">Items Endpoint Example: XML Text Search for 'uniformRes'</a></p>
      <p><a href="/cs_api/1.0/items?msg_id_text=ECCNET&json=true"  target="_blank">Items Endpoint Example: Latest ECCnet Items by Msg ID</a></p>
      <p><a href="/cs_api/1.0/items?gtin=279&tm=840&json=true"     target="_blank">Items Endpoint Example: GTIN with 279, TM 840</a></p>
      <p><a href="/cs_api/1.0/items?page=2&per_page=10&json=true"  target="_blank">Items Endpoint Example: Most Recently Modified, 21 - 30</a></p>
      <p><a href="/cs_api/1.0/items?unit_type=CASE&json=true"      target="_blank">Items Endpoint Example: Case Items, Most Recently Modified, 1 - 10</a></p>
      <p><a href="/cs_api/1.0/subscribed/00038000105234"           target="_blank">Subscriber Endpoint Example: GTIN 00038000105234</a></p>
      <p><a href="/cs_api/1.0/subscribed/00067000004650?transform=server&lang=fr" target="_blank">Subscriber Endpoint Example: bp_cps fr item</a></p>
      <p><a href="/cs_api/1.0/lookup_allergens?lang=es"           target="_blank">Allergen Code Lookup Endpoint Example: List by lang</a></p>
      <p><a href="/cs_api/1.0/lookup_allergens?lang=en&code=AC"   target="_blank">Allergen Code Lookup Endpoint Example: AC/en</a></p>
      <p><a href="/cs_api/1.0/lookup_countries?lang=en"            target="_blank">Country Code Lookup Endpoint Example: List by lang</a></p>
      <p><a href="/cs_api/1.0/lookup_countries?lang=es&code=840"   target="_blank">Country Code Lookup Endpoint Example: 840/es</a></p>
      <p><a href="/cs_api/1.0/lookup_nutrients?lang=en"           target="_blank">Nutrient Code Lookup Endpoint Example: List by lang</a></p>
      <p><a href="/cs_api/1.0/lookup_nutrients?lang=en&code=VITC" target="_blank">Nutrient Code Lookup Endpoint Example: VITC/en</a></p>
    </div>
    <div id="welcome">[Loading welcome.html]</div>
  </div>

  <div id="msg_tab" ng-controller="thx_msg_controller">
    <div id="msg_accordion">

      <div>Search Messages</div>
      <div>
        <br/>
        <button ng-if="page > 0" ng-click="list_messages(-1)">Prev</button>
        <button ng-if="messages && messages.length == 10" ng-click="list_messages(1)">Next</button>
        <div ng-if="messages" style="border-style:solid;border-width:1px;border-color:green">
          <table>
            <tr>
              <th>ID</th>
              <th>Sender</th>
              <th>Receiver</th>
              <th>Created</th>
              <th>Modified</th>
            </tr>
            <tr class="clickable" ng-repeat="msg in messages" ng-click="showMessageDetail(msg)">
              <td>{{msg.msg_id}}</td>
              <td>{{msg.sender}}</td>
              <td>{{msg.receiver}}</td>
              <td>{{msg.created_ts}}</td>
              <td>{{msg.modified_ts}}</td>
              <!-- Raw Data: '{{msg}}' -->
            </tr>
          </table>
        </div><!-- end ng-if="messages" -->
        <button ng-if="!messages" ng-click="list_messages()">Load Messages</button>
      </div>

      <div>View Message</div>
      <div>
        Message ID:
        <br/><input type="text" ng-model="view_msg_id"/>
        <br/><button ng-click="view_msg()">View</button>
        <br/><textarea rows="6" cols="100" id="msg_content_view"></textarea>
        <br/><span ng-if="view_msg_id">[<a ng-href="/cs_api/1.0/msg/{{view_msg_id}}">Link to message {{view_msg_id}}</a>]</span>
      </div>

      <div>Post Message</div>
      <div>
        <div ng-controller="thx_file_controller">
          <input type="file" ng-file-select="onFileSelect($files, 'msg_url')"></input>
          <button ng-click="uploadFile('msg_url')">Upload File</button>
        </div>
        <div>
          <br/><textarea rows="6" cols="100" ng-model="msg_content_post"></textarea>
          <br/><button ng-click="post_msg()">Post</button>
        </div>
      </div>

      <div>JSON Data</div>
      <div>
        <button ng-click="list_msg()">Update</button>
        <pre id="message_list"></pre>
      </div>

    </div>
  </div> <!-- end msg_tab -->

  <div id="party_tab" ng-controller="thx_party_controller">
    <div id="party_accordion">

      <div>Search Trading Parties</div>
      <div>
        <br/>
        <button ng-if="!parties" ng-click="list_parties()">Load Parties</button>
        <button ng-if="page > 0" ng-click="list_parties(-1)">Prev</button>
        <button ng-if="parties && parties.length == 10" ng-click="list_parties(1)">Next</button>
        <div ng-if="parties" style="border-style:solid;border-width:1px;border-color:green">
          <table>
            <tr>
              <th>Name</th>
              <th>GLN</th>
              <th>Country</th>
              <th>Data Pool</th>
              <th>Created</th>
              <th>Modified</th>
            </tr>
            <tr class="clickable" ng-repeat="party in parties" ng-click="showPartyDetail(party)">
              <td>{{party.name}}</td>
              <td>{{party.gln}}</td>
              <td>{{party.country}}</td>
              <td>{{party.data_pool_gln}}</td>
              <td>{{party.created_ts}}</td>
              <td>{{party.modified_ts}}</td>
              <!-- Raw Data: '{{party}}' -->
            </tr>
          </table>
        </div>
      </div>

      <div>Trading Party Details</div>
      <div>
        GLN:
        <br/><input type="text" ng-model="input_party_gln"/>
        <br/><button ng-click="view_party()">View</button>
        <br/><textarea rows="6" cols="100" id="party_content_view"></textarea>
        <br/><span ng-if="input_party_gln">[<a ng-href="/cs_api/1.0/party/{{input_party_gln}}?download=true">Download link to catalog party {{input_party_gln}}</a>]</span>
      </div>

      <div>Post Trading Parties RPDD File</div>
      <div>
        <div ng-controller="thx_file_controller">
          <input type="file" ng-file-select="onFileSelect($files, 'parties_url')"></input>
          <button ng-click="uploadFile('parties_url')">Upload File</button>
        </div>
        <div>
          <br/>Or paste CIN XML:
          <br/><textarea rows="6" cols="100" ng-model="party_content_post"></textarea>
          <br/><button ng-click="post_parties()">Post XML</button>
        </div>
      </div>

    </div>
  </div> <!-- end party_tab -->

  <div id="item_tab" ng-controller="thx_item_controller">
    <div id="item_accordion">

      <div>Search Catalog Items</div>
      <div>
        <span>GTIN          <input type="text" ng-model="input_item_gtin" size="16" placeholder="99999999999999"></input></span>
        <span>Provider GLN  <input type="text" ng-model="input_item_provider" size="15" placeholder="1100001011292"></input></span>
        <span>Recipient GLN <input type="text" ng-model="input_item_recipient" size="15" placeholder="0625199000015"></input></span>
        <span>TM Country    <input type="text" ng-model="input_item_tm" size="3" placeholder="840"></input></span>
        <span>TM Sub        <input type="text" ng-model="input_item_tm_sub" size="5" placeholder="US-CA"></input></span>
        <span>Include total count <input type="checkbox" ng-model="input_include_total_count"></input></span>
        <span>Per page      <input ng-model="input_per_page" size="3"></input></span>
        <p/>
        <span>XML Regex     <input type="text" ng-model="input_item_xml_text" size="30" placeholder="foodAndBev"></input></span>
        <span>Msg ID Regex  <input type="text" ng-model="input_item_msg_id_text" size="30" placeholder="CIN_IN_"></input></span>
        <span>Unit Descriptor
          <select ng-model="input_item_unit_descriptor">
            <option value="CASE">Case</option>
            <option value="BASE_UNIT_OR_EACH">Each</option>
            <option value="DISPLAY_SHIPPER">Display Shipper</option>
            <option value="MIXED_MODULE">Mixed Module</option>
            <option value="MULTIPACK">Multipack</option>
            <option value="PACK_OR_INNER_PACK">Pack or Inner Pack</option>
            <option value="PALLET">Pallet</option>
            <option value="PREPACK">Prepack</option>
            <option value="PREPACK_ASSORTMENT">Prepack Assortment</option>
            <option value="SETPACK">Setpack</option>
            <option value="TRANSPORT_LOAD">Transport Load</option>
          </select>
        </span>
        <button ng-click="list_items(0)">Search</button>
        <button ng-click="reset_search()">Reset</button>
        <p/>
        <div ng-if="items">
          <table width="100%">
            <tr>
              <th>Photo</th>
              <th>GTIN</th>
              <th>Provider</th>
              <th>TM Country</th>
              <th>TM Sub</th>
              <th>Recipient</th>
              <th>Child Count</th>
              <th>Created</th>
              <th>Modified</th>
              <th>CIN Message</th>
            </tr>
            <tr class="clickable" ng-repeat="item in items" ng-click="showItemDetail(item)">
              <td><img height="30" ng-src="{{ item.thumbnail }}"/></td>
              <td>{{item.gtin}}</td>
              <td>{{item.provider}}</td>
              <td>{{item.tm}}</td>
              <td>{{item.tm_sub}}</td>
              <td>{{item.recipient}}</td>
              <td>{{item.child_gtins && item.child_gtins.length}}</td>
              <td>{{item.created_ts}}</td>
              <td>{{item.modified_ts}}</td>
              <td>{{item.msg_id}}</td>
            </tr>
          </table>
          <p/>
          <p class="centered">
            <button ng-if="page > 1" ng-click="list_items(-page)">First</button>
            <button ng-if="page > 0" ng-click="list_items(-1)">Prev</button>
            <span>Page:<span>{{ page + 1 }}</span>
            <button ng-if="more_items" ng-click="list_items(1)">Next</button>
            <button ng-if="total_item_count && more_items" ng-click="list_items((total_item_count / per_page) - page)">Last</button>
            <div class="centered"></span>Displaying items <span>{{ item_range_start }}</span> to {{ item_range_end }}</div>
            <div class="centered" ng-if="!(more_items)">No more items to display</div>
            <div class="centered" ng-if="total_item_count && input_include_total_count">Total number of matching items <span>{{ total_item_count }}</span></div>
          </p>

          <div ng-if="selectedItem" id="selectedItem" class="blue_box">
            <div>
              <table width="100%">
                <tr>
                  <th width="40%">
                    <div ng-if="selectedItem.images && selectedItem.images.length">
                      <p><img ng-repeat="url in selectedItem.images" ng-src="{{ url }}" ng-mouseover="selectImage(url)" height="50"></img></p>
                      <p>
                        <a ng-href="{{selectedImage}}" target="_blank">
                        <img ng-src="{{selectedImage}}" width="200"></img>
                        <br/>{{selectedImage}}</a>
                      </p>
                    </div>
                  </th>
                  <th border="1">
                    <p>GTIN: {{selectedItem.gtin}}</p>
                    <p>Name: {{selectedItem.tradeItem.tradeItemInformation.tradeItemDescriptionInformation.functionalName.description[0].shortText}}</p>
                    <p>Brand: {{selectedItem.brand}}</p>
                    <p>Short Description: {{selectedItem.tradeItem.tradeItemInformation.tradeItemDescriptionInformation.descriptionShort.description[0].shortText}}</p>
                    <p>Description: {{selectedItem.tradeItem.tradeItemInformation.tradeItemDescriptionInformation.tradeItemDescription[0].text}}</p>
                    <p>Additional Description: {{selectedItem.tradeItem.tradeItemInformation.tradeItemDescriptionInformation.additionalTradeItemDescription[0].text}}</p>
                    <p>GPC Brick Code: {{selectedItem.gpc}}</p>
                    <p>Child GTINs: {{selectedItem.child_gtins.join(' ')}}</p>
                  </th>
                  <th>
                    <div ng-if="selectedItem.has_extension"><p>Some extension: <span>{{selectedItem.has_extension}}</span></p>
                        <div ng-if="selectedItem.has_food_and_bev"><p>Food extension: {{selectedItem.has_food_and_bev}}</p>
                            <div ng-if="selectedItem.has_nutrient_info"><p>Nutritient info: {{selectedItem.has_nutrient_info}}</p>
                                <div ng-if="selectedItem.preparationStates && selectedItem.preparationStates.length">
                                  <p>Preparation states: <span ng-repeat="state in selectedItem.preparationStates"> {{ state }} </span></p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <p>Unit type: {{selectedItem.unit_type}}</p>
                    <p>Source DP: {{selectedItem.source_dp}}</p>
                    <p>XML: <a ng-href="{{selectedItem.href}}?" target="_blank">View</a> <a ng-href="{{selectedItem.href}}?download=true">Download</a></p>
                    <p>JSON: <a ng-href="{{selectedItem.href}}?json=true&include_trade_item=true" target="_blank">View</a> <a ng-href="{{selectedItem.href}}?json=true&include_trade_item=true&download=true">Download</a></p>
                    <p><a class="clickable" ng-click="prettyPrintItem(selectedItem)">PrettyPrint Item</a></p>
                    <p><a class="clickable" ng-click="showItemHierarchy(selectedItem)">Hierarchy</a></p>
                  </th>
                </tr>
              </table>
            </div>

            <div width="100%" id="three_item_view"></div>

          </div> <!-- end if selectedItem -->
        </div> <!-- end if items -->

        <div ng-if="previousSearches" class="blue_box">
          <p>Search History:</p>
          <p class="clickable" ng-repeat="search in previousSearches" ng-click="redoPreviousItemSearch(search)">{{ search }}</p>
        </div>

      </div>

      <div>Catalog Item Details</div>
      <div>
        GTIN:
        <br/><input type="text" ng-model="input_item_gtin"/>
        <br/><button ng-click="view_catalog_item()">View</button>
        <br/><textarea rows="6" cols="100" id="item_content_view"></textarea>
        <br/><span ng-if="input_item_gtin">[<a ng-href="/cs_api/1.0/items/{{input_item_gtin}}?download=true">Download link to catalog item {{input_item_gtin}}</a>]</span>
      </div>

      <div>Post Catalog Items</div>
      <div>
        <div ng-controller="thx_file_controller">
          <input type="file" ng-file-select="onFileSelect($files, 'item_url')"></input>
          <button ng-click="uploadFile('item_url')">Upload File</button>
        </div>
        <div>
          <br/>Or paste CIN XML:
          <br/><textarea rows="6" cols="100" ng-model="item_content_post"></textarea>
          <br/><button ng-click="post_catalog_items()">Post XML</button>
        </div>
      </div>

    </div>
  </div> <!-- end item_tab -->

  <div id="pub_tab" ng-controller="thx_pub_controller">
    <div id="pub_accordion">

      <div>Search Publications</div>
      <div id="pub_list">
        <div>
          <input type="text" ng-model="publisher"></input>
          <input type="button" ng-click="getPublications(publisher)" value="Get Publications"></input>
          <div ng-if="data.publisher">
            <div>Publications for ITN publisher {{data.publisher}} as of <span ng-bind="timestamp"/>:</div>
            <div class="clickable" ng-repeat="pub in data.publications" ng-click="showPubDetail(pub)">
              <span>{{$index + 1}}. Published to GLN: {{pub.publishToGLN}}
                <br/>Item GTIN: {{pub.gtin}}
                <br/>Item TM/TMSub: {{pub.tm}}/{{pub.tmsub}}
              </span>
            </div>
          </div>
          <div ng-if="data.url">Data URL: <a ng-href="{{data.url}}">{{data.url}}</a></div>
        </div>
      </div>

      <div>Find Unpublished Items</div>
      <div id="find_not_pub">Loading...</div>

      <div>Publish Item to Subscriber GLN</div>
      <div id="pub_util">
        <form id="pub_form">
            <p>* Publisher GLN:<br/><input type="text" name="ds" ng-model="publisher"/></p>
            <p>* Product GTIN:<br/><input type='text' name='gtin'/></p>
            <p>* Product TM numeric ISO code (e.g. '840'):<br/><input type='text' name='tm'/></p>
            <p>  Product TM subdivision alpha code (e.g. 'US-CA'):<br/><input type='text' name='tms'/></p>
            <p>* Publish-To GLN:<br/><input type='text' name='dr'ng-model="subscriber"/></p>
            <p>Initial load<br/><input type='checkbox' name='il'/></p>
            <button ng-click="publish_item()">Submit</button>
            <div id="pub_result">Loading...</div>
        </form>
      </div>

    </div>
  </div> <!-- end pub_tab -->

  <div id="sub_tab" ng-controller="thx_sub_controller">
    <div id="sub_accordion">
      <div>Fetch Subscribed Items</div>
      <div>

        <div>
          <form id="sub_form">
            <table>
              <tr>
                <td>
                  <p>* GTIN<br/><input id="input_gtin" value="00038000105234" size="40"></input></p>
                  <p>Provider GLN<br/><input id="input_provider" value="" size="40"></input></p>
                </td>
                <td>
                  <p>Target Market Country Code<br/><input id="input_tm" value="" size="40"></input></p>
                  <p>Target Market Subdivision Code<br/><input id="input_tm_sub" value="" size="40"></input></p>
                </td>
              </tr>
              <tr>
                <td>
                  <p><input id="input_include_children" type="checkbox"></input>  Include Children</p>
                  <p><input id="input_include_parents" type="checkbox"></input>   Include Parents</p>
                  <p><input id="input_food_only" type="checkbox"></input>         Only items with Food/Bev Info </p>
                </td>
                <td>
                  <p>Data Transform <select name="trans_type" id="input_server_transform"><option value="">None</option><option value="client">Client</option><option value="server">Server</option></select></p>
                  <p><input id="input_multi_gtin" type="checkbox"></input>        Multi: allow multiple items with same GTIN</p>
                </td>
              </tr>
              <tr>
                <td>
                  <p><button id="btn_fetch" ng-click="getSubscribedItems()">Fetch Items</button></p>
                </td>
                <td>
                  <p><button id="btn_fetch_hide" ng-click="resetSubscribedItems()">Clear Results</button></p>
                </td>
              </tr>
            </table>
          </form>
        </div>

        <p id="sub_error" ng-if="sub_error">{{ sub_error }}</p>
        <div id="sub_result" ng-if="subscribed_items">
          <p id="sub_msg" ng-if="sub_msg">{{ sub_msg }}</p>
          <div ng-repeat="item in subscribed_items">
            <span>Item {{ item.href }} ({{ item.fetch_type }}):</span>
            <br/><textarea rows="6" cols="120">{{ item }}</textarea>
          </div>
        </div>

      </div> <!-- end sub_client -->

      <div>Search Subscriptions</div>
      <div>
        <input type="text" ng-model="subscriber"></input>
        <input type="button" ng-click="getSubscriptions(subscriber)" value="Get Subscriptions"></input>
        <div gdsn-subscriptions default-subscriber="1100001011292"/>
      </div>

    </div> <!-- end sub_accordion -->
  </div> <!-- end sub_tab -->

</div><!-- end tabs -->



<div id="debug_tab" ng-controller='thx_debug_controller'>
  <div id="debug_accordion">
  	<div>MongoDB Logging</div>
  	<div>
        <p/>
        <span>Message Regex     <input type="text" ng-model="input_log_regex" size="30" placeholder="req_id"></input></span>
        <span>Start Date     <input type="text" size="10" ng-model="input_startdate" placeholder="8/21/2014" ></input></span>
        <span>End Date     <input type="text" size="10" ng-model="input_enddate" placeholder="8/29/2014" ></input></span>
        <span>Username     <input type="text" size="15" ng-model="input_username" placeholder="per" ></input></span>
        <span>Duration (ms)     <input type="text" size="8" ng-model="input_duration" placeholder="200" ></input></span>
        <span>Log Level
          <select ng-model="input_log_level">
            <option value="debug">debug</option>
            <option value="info">info</option>
            <option value="warn">warn</option>
            <option value="error">error</option>
          </select>
        </span>
<!--    
		<span>Action Type
          <select ng-model="input_action_type">
            <option value="subscribed">subscribed</option>
            <option value="Subscription">Subscription</option>
            <option value="Publication">Publication</option>
            <option value="ItemLoad">Item Load</option>
          </select>
        </span>
 -->
        <span>Include total count <input type="checkbox" ng-model="input_include_total_count"></input></span>
        <span>Rows/page      <input ng-model="input_per_page" size="3"></input></span>
        <button ng-click="list_fileLogs(0)">Search</button>
        <button ng-click="reset_log_search()">Reset</button>

        <div ng-if="fileLogs" style="border-style:solid;border-width:1px;border-color:green">
          <table>
            <tr>
              <th>Timestamp</th>
              <th>Level</th>
              <th>Message</th>
              <th>Username</th>
              <th>Duration<br />(ms)</th>
              <th>Id</th>
            </tr>
            <tr class="clickable" ng-repeat="fileLog in fileLogs">
              <td>{{fileLog.timestamp}}</td>
              <td>{{fileLog.level}}</td>
              <td>{{fileLog.message}}</td>
              <td>{{fileLog.username}}</td>
              <td>{{fileLog.duration}}</td>
              <td>{{fileLog._id}}</td>
              <!-- Raw Data: '{{fileLog}}' -->
            </tr>
          </table>
        </div>
        
        <p class="centered">
            <button ng-if="page > 1" ng-click="list_fileLogs(-page)">First</button>
            <button ng-if="page > 0" ng-click="list_fileLogs(-1)">Prev</button>
            <span>Page:<span>{{ page + 1 }}</span>
            <button ng-if="more_items" ng-click="list_fileLogs(1)">Next</button>
            <button ng-if="total_item_count && more_items" ng-click="list_fileLogs((total_item_count / per_page) - page)">Last</button>
            <div class="centered"></span>Displaying items <span>{{ item_range_start }}</span> to {{ item_range_end }}</div>
            <div class="centered" ng-if="!(more_items)">No more items to display</div>
            <div class="centered" ng-if="total_item_count && input_include_total_count">Total number of matching items <span>{{ total_item_count }}</span></div>
	    </p>
        
	</div>

  	<div>Already existing...</div>
  	<div>
	  <div>Model values:</div>
	  <div>Subscriber: {{subscriber}}</div>
	  <div>Publisher: {{publisher}}</div>
	  <div>View Message ID: {{view_msg_id}}</div>
	  <div>Message post content: <textarea disabled>{{msg_content_post}}</textarea></div>
	  <div id="snoop">Loading...</div>
	</div>
	
  </div>   <!-- end debug_accordion -->
</div>  <!-- end debug_tab -->



<div id="footer_area">
  <p>Copyright &copy; 2014</p>
</div>

<div id="result_dialog">Loading...</div>

<div id="error_dialog">An error occurred!</div>

<div id="progress_dialog">
    <p class="vert_spacer" ></p>
    <div id="progressbar"></div>
</div>

<script>
  (function() {

    var log = function (msg) {
      if (console && console.log) console.log(msg)
      else alert(msg)
    }

    app = {
      version: "1.0"
      , ts: Date.now()
      , debug: true
      , api: '/cs_api/1.0'
    }

    var $party_accordion = $("#party_accordion")
    $party_accordion.accordion({
        heightStyle: 'content',
        collapsible: true
    })

    var $item_accordion = $("#item_accordion")
    $item_accordion.accordion({
        heightStyle: 'content',
        collapsible: true
    })

    var $pub_accordion = $('#pub_accordion')
    $pub_accordion.accordion({
        heightStyle: 'content',
        collapsible: true
    })

    var $sub_accordion = $('#sub_accordion')
    $sub_accordion.accordion({
        heightStyle: 'content',
        collapsible: true
    })

    var $debug_accordion = $('#debug_accordion')
    $debug_accordion.accordion({
        heightStyle: 'content',
        collapsible: true
    })

    var $msg_accordion = $('#msg_accordion')
    $msg_accordion.accordion({
        heightStyle: 'content',
        collapsible: true
    })

    var $result_dialog = $('#result_dialog')
    $result_dialog.dialog({
      autoOpen: false
      , title: 'Selected Results'
      , width: 1000
      , modal: true
      , buttons: { OK: function() { $result_dialog.dialog('close') } }
    })
    
    var $error_dialog = $('#error_dialog')
    $error_dialog.dialog({
      autoOpen: false
      , title: 'Error'
      , width: 500
      , modal: true
      , buttons: { OK: function() { $error_dialog.dialog('close') } }
    })
    
    var $progress_dialog = $('#progress_dialog')
    $progress_dialog.dialog({
      autoOpen: false
      , width: 700
      , modal: true
    })

    function showBusy(title) {
      log('busy 2: ' + title)
      $progress_dialog.dialog('option', 'title', title)
      $progress_dialog.dialog('open')
    }

    function hideBusy() {
      setTimeout(function () {
        $progress_dialog.dialog('close')
      }, 500)
    }

    var thx_app = angular.module('thx_app', ['angularFileUpload'])

    thx_app.factory('thx_util', function () {
      return {
          sub_url         : app.api + '/subscriptionList'
        , pub_url         : app.api + '/publicationList'
        , msg_url         : app.api + '/msg'
        , item_url        : app.api + '/items'
        , items_list_url  : app.api + '/items-list'
        , item_detail_url : app.api + '/item'
        , party_url       : app.api + '/party'
        , parties_url     : app.api + '/parties'
        , logs_url        : app.api + '/logs'
      }
    })

    thx_app.controller('thx_file_controller', function($scope, $upload, thx_util) {
      $scope.onFileSelect = function($files, url) {
        $scope[url + '_file'] = $files && $files[0]
      }
      $scope.uploadFile = function(url) {
          var file = $scope[url + '_file']
          if (!file) return
          $scope.upload = $upload.upload({
            url: thx_util[url], // 'cs_api/1.0/items',
            //url: 'item', // cheerio
            // method: POST or PUT,
            // headers: {'headerKey': 'headerValue'},
            // withCredentials: true,
            //data: {myObj: $scope.myModelObj},
            file: file,
          })
          .progress(function(evt) {
            log('percent: ' + parseInt(100.0 * evt.loaded / evt.total))
          })
          .success(function(data, status, headers, config) {
            // file is uploaded successfully
            log('ajax upload file succeeded')
            log(data)
            alert('File uploaded successfully (' + data.msg + ')')
          })
          .error(function(msg) {
            log('ajax upload file failed')
            log(arguments)
            $error_dialog.html('An error occurred: ' + msg).dialog('open')
          })
      }
    })

    thx_app.controller('thx_sub_controller', function($scope, $http, thx_util) {
      $scope.timestamp = 'n/a'
      $scope.thx_controller_test = 'thx_controller_test_value'

      $scope.selectSubscription = function (sub) {
        log('selectSubscription')
        log(sub)
        $scope.selectedSub = JSON.stringify(sub)
        //$scope.selectedSub = sub
      }

      $scope.getSubscriptions = function () {
        if (/\d{13}/.test($scope.subscriber)) {
          //$http.get(thx_util.sub_url, { 
          $http.jsonp('http://plt-gdsn01.itradenetwork.com:8080/gdsn-server/api/getSubscriptionList' , {
            params: { subscriber: $scope.subscriber, callback: 'JSON_CALLBACK' }
          })
          .success(function (data) {
            $scope.data = data
            $scope.timestamp = data.timestamp
            $scope.selectedSub = null
          })
          .error(function () {
            log(arguments)
          })
        }
        else {
          alert('Error: invalid gln, should be 13 digits')
        }
      }

      $scope.resetSubscribedItems = function () {
        console.log('resetSubscribedItems')
        $scope.sub_error = null
        $scope.subscribed_items = null
      }

      $scope.getSubscribedItems = function () {
        console.log('getSubscribedItems')

        var gtin = $('#input_gtin').val()
        if (!gtin) return alert('GTIN is required')

        var provider  = $('#input_provider').val()
        var tm        = $('#input_tm').val()
        var tm_sub    = $('#input_tm_sub').val()
        var transform = $('#input_server_transform').val()
        log('transform param: ' + transform)
        var children  = $('#input_include_children').prop('checked')
        var parents   = $('#input_include_parents').prop('checked')
        var multi     = $('#input_multi_gtin').prop('checked')
        var food     = $('#input_food_only').prop('checked')

        var url = app.api + '/subscribed/' //+ gtin
        log('url: ' + url)

        var form_serialize = $('#sub_form').serialize()
        log('sub form form_serialize: ' + form_serialize)

        showBusy('Fetching subscribed items...')

        //$http.jsonp(url, {
        //$http.get('/err', {
        $http.get(url, {
          params: { 
              gtin: gtin
            , provider: provider
            , tm: tm
            , tm_sub: tm_sub
            , children: children
            , parents: parents
            , multi: multi
            , transform: transform
            , food: food
            //, callback: 'JSON_CALLBACK'
          }
        })
        .success(function (data) {
          hideBusy()
          if (data.collection.error) {
            $scope.subscribed_items = null // clear previous results to avoid confusion
            var e = data.collection.error
            $scope.sub_error = 'Error: ' + e.title + ' (' + e.message + ')'
            $error_dialog.html('An error occurred: ' + e.title + ' (' + e.message + ')')
            if (data.collection.links) {
              var links = data.collection.links
            }
            return
          }
          var items = data.collection.items || []
          $scope.sub_msg = 'Item count: ' + items.length
          $scope.sub_error = null

          items = items.map(function (item) {
            if (transform == 'client') item = cs_client.transform(item)
            log('appending item ' + item.gtin)
            return item
          })
          $scope.subscribed_items = items
        })
        .error(function (msg) {
          log('ajax getSubscribedItems failed')
          log(arguments)
          $scope.sub_error = 'Error: ' + msg
          $scope.subscribed_items = null // clear previous results to avoid confusion
          hideBusy()
          $error_dialog.html('An error occurred: ' + msg).dialog('open')
        })
      }
    })

    thx_app.controller('thx_pub_controller', function($scope, $http, thx_util) {
      $scope.timestamp = 'n/a'
      $scope.thx_controller_test = 'thx_controller_test_value'

      $scope.showPubDetail = function (pub) {
        log('showPubDetail')
        log(pub)
        $scope.selectedPub = JSON.stringify(pub)
        //$scope.selectedPub = pub
      }

      $scope.getPublications = function (pubGln) {
        //$http.get(thx_util.pub_url, { 
        $http.jsonp('http://plt-gdsn01.itradenetwork.com:8080/gdsn-server/api/getPublicationList' , {
          params: { publisher: pubGln, callback: 'JSON_CALLBACK' }
        })
        .success(function (data) {
          $scope.data = data
          $scope.timestamp = data.timestamp
          $scope.selectedPub = null
        })
        .error(function () {
          log('ajax getPublications failed')
          log(arguments)
          alert('getPublications failed: ' + msg)
        })
      }

      $scope.publish_item = function () {
        var $pub_result = $('#pub_result')
        $pub_result.hide()
        var data = $('#pub_form').serialize()
        log('publishing item with data: ' + data)

        $http.get(app.api + '/publish?' + data, { 
          params: { page: $scope.page }
        })
        .success(function (messages) {
          alert('API Publish operation complete: ' + status)
          log('API Publish operation complete: ' + status)
          $pub_result.append('<div>Result: ' + status + '</div>')
          $pub_result.show()
          hideBusy()
        })
        .error(function () {
          log('ajax publish_item failed')
          log(arguments)
          hideBusy()
          $error_dialog.html('An error occurred -- please try again').dialog('open')
        })
      }

    })

    thx_app.controller('thx_msg_controller', function($scope, $http, thx_util) {

      $scope.page = 0

      $scope.list_messages = function (pageIncrement) {
        if (pageIncrement) {
          $scope.page += pageIncrement
        }
        else {
          $scope.page = 0
        }
        log('list_messages called with page increment ' + pageIncrement)

        showBusy('Fetching message list...')
        $http.get(thx_util.msg_url, { 
          params: { page: $scope.page }
        })
        .success(function (messages) {
          $scope.messages = _.map(messages, function (msg) {
            msg.created_ts = (new Date(msg.created_ts)).toLocaleString()
            msg.modified_ts = (new Date(msg.modified_ts)).toLocaleString()
            return msg
          })
          hideBusy()
        })
        .error(function () {
          hideBusy()
          $error_dialog.html('An error occurred -- please try again').dialog('open')
        })
      }

      $scope.showMessageDetail = function (msg) {
        log('showMessageDetail called for msg ' + msg.msg_id)
        $result_dialog.html(prettyPrint(msg)).dialog('open')
      }

      $scope.list_msg = function () {
        $('#message_list').load(thx_util.msg_url)
      }

      $scope.view_msg = function () {
        $('#msg_content_view').load(thx_util.msg_url + '/' + $scope.view_msg_id)
      }

      $scope.post_msg = function () {
        $http.post(thx_util.msg_url, $scope.msg_content_post + '\n\n')
        .success(function (data) {
          log(data)
        })
        .error(function () {
          log(arguments)
        })
      }

    })

    thx_app.controller('thx_item_controller', function($scope, $http, thx_util) {

      $scope.page = 0
      $scope.per_page = 10
      $scope.more_items = true

      $scope.showItemDetail = function (item) {
        log('showItemDetail called for gtin ' + item.gtin)
        $scope.selectedItem = item
        if (item.images && item.images.length) $scope.selectImage(item.images[0])

        $('#three_item_view').empty()
      }

      $scope.redoPreviousItemSearch = function (params) {
        log('redoPreviousItemSearch with params: ' + JSON.stringify(params))
        $scope.executeItemSearch(params)
      }

      $scope.showItemHierarchy = function (item) {
        log('showItemHierarchy start for item ' + item.gtin)

        showBusy('Fetching item details...')

        var params = {
            req_id   : 'hier_' + Date.now() + '_' + item.gtin
          , children : true
          , include_trade_item: true
        }

        console.log('item.href: ', item.href)

        $http.get(item.href, { params: params }).success(function (data) {
          var items = []
          try {
            items = data.collection.items || []
          }
          catch (e) {console.log(e)}

          console.log('found ' + (items && items.length) + ' items (including children) for item ' + item.gtin)

          if (init_three_view) init_three_view($('#three_item_view'), items)

          $scope.hierarchy_items = items

          hideBusy()

          console.log('showItemHierarchy done')
        })
        .error(function () {
          hideBusy()
          $error_dialog.html('An error occurred -- please try again').dialog('open')
        })
      }

      $scope.selectImage = function (url) {
        //log('selectImage  called with url ' + url)
        $scope.selectedImage = url
      }

      $scope.prettyPrintItem = function (item) {
        log('prettyPrintItem  called for gtin ' + item.gtin)
        $result_dialog.html(prettyPrint(item)).dialog('open')
      }

      $scope.reset_search = function () {
        delete $scope.input_item_gtin
        delete $scope.input_item_provider
        delete $scope.input_item_recipient
        delete $scope.input_item_tm
        delete $scope.input_item_tm_sub
        delete $scope.input_item_xml_text
        delete $scope.input_item_msg_id_text
        delete $scope.input_item_unit_descriptor
        delete $scope.input_include_total_count
        delete $scope.total_item_count
        delete $scope.items
        delete $scope.page
        delete $scope.more_items
        delete $scope.search_params

        delete $scope.previousSearches
        //delete $scope.input_per_page
      }

      $scope.list_items = function (pageIncrement) {
        pageIncrement = Math.floor(pageIncrement)
        console.log('list_items pageIncrement ' + pageIncrement)

        $scope.search_params = $scope.search_params || {} // create new if needed
        $scope.input_per_page = $scope.input_per_page || 10
        
        if (pageIncrement) {
          $scope.page += pageIncrement              // note that we don't allow per_page to be changed when paging
          $scope.search_params.page = $scope.page
          $scope.search_params.include_total_count = false // don't recount when paging
        }
        else { // only reread search params from form and reset counts if not paging
          $scope.page = 0
          $scope.total_item_count = 0
          $scope.per_page = $scope.input_per_page || 10
          $scope.search_params = {
              page                : $scope.page 
            , per_page            : $scope.per_page
            , include_total_count : $scope.input_include_total_count
            , gtin                : $scope.input_item_gtin
            , provider            : $scope.input_item_provider
            , recipient           : $scope.input_item_recipient
            , tm                  : $scope.input_item_tm
            , tm_sub              : $scope.input_item_tm_sub
            , xml_text            : $scope.input_item_xml_text
            , msg_id_text         : $scope.input_item_msg_id_text
            , unit_type           : $scope.input_item_unit_descriptor
            , req_ts              : Date.now()
            , exclude_trade_item  : false
            , include_trade_item  : true
          }
          $scope.previousSearches = $scope.previousSearches || []
          $scope.previousSearches.unshift($scope.search_params)
        }

        $scope.executeItemSearch($scope.search_params)
      }

      $scope.executeItemSearch = function (search_params) {

        console.log('include total count checkbox: ' + $scope.input_include_total_count)
        console.log('page num to request: ' + $scope.page)

        showBusy('Fetching item list...')

        //$http.get(thx_util.items_list_url, {params: $scope.search_params})
        $http.get(thx_util.items_list_url, {params: search_params})
        .success(function (data) {
        console.log( JSON.stringify(data) )
          var items = []
          try {
            items = data.collection.items || []
          }
          catch (e) {console.log(e)}

          if (data.collection.total_item_count) $scope.total_item_count = data.collection.total_item_count
          if (data.collection.item_range_start) $scope.item_range_start = data.collection.item_range_start 
          if (data.collection.item_range_end)   $scope.item_range_end   = data.collection.item_range_end   

          $scope.selectedItem = null

          if (items.length) {
            $scope.items = _.map(items, function (item) {
              item.created_ts        = (new Date(item.created_ts)).toLocaleString()
              item.modified_ts       = (new Date(item.modified_ts)).toLocaleString()
              item.has_extension     = !!(item.tradeItem && item.tradeItem.extension)
              item.has_food_and_bev  = item.has_extension && !!(item.tradeItem.extension.foodAndBeverageTradeItemExtension)
              
              item.has_nutrient_info = item.has_food_and_bev
                && !!(item.tradeItem.extension.foodAndBeverageTradeItemExtension.foodAndBeverageInformation)
                && !!(item.tradeItem.extension.foodAndBeverageTradeItemExtension.foodAndBeverageInformation[0])
                && !!(item.tradeItem.extension.foodAndBeverageTradeItemExtension.foodAndBeverageInformation[0].foodAndBeverageNutrientInformation)

              if (item.has_nutrient_info) {
                item.preparationStates = item.tradeItem.extension.foodAndBeverageTradeItemExtension.foodAndBeverageInformation.map(function (fbi) {
                  return fbi.foodAndBeverageNutrientInformation.map(function (elem) {
                    return (elem.preparationState && elem.preparationState.length) ? elem.preparationState : false
                  })
                })
                item.preparationStates = _.compact(_.flatten(item.preparationStates))
              }
              console.log(item.gtin + ' preparationStates: ' + JSON.stringify(item.preparationStates))

              item.thumbnail = item.images && item.images.length ? item.images[0] : './icon_camera.png'

              return item
            })
            console.log('Found ', items.length, ' items')
            console.log('Per page ', $scope.per_page, ' items')

            $scope.more_items = (items.length == $scope.per_page)
          }
          else {
            if ($scope.page > 0) $scope.page--
            $scope.more_items = false
          }
          hideBusy()
        })
        .error(function () {
          hideBusy()
          $error_dialog.html('An error occurred -- please try again').dialog('open')
        })
      }

      $scope.post_catalog_items = function () {
        //$http.post('/item', $scope.item_content_post + '\n\n') // cheerio testing
        $http.post(thx_util.item_url, $scope.item_content_post + '\n\n')
        .success(function (data) {
          log('data: ' + data)
          log(data.msg)
          log(JSON.stringify(data))
          alert('XML text uploaded successfully (' + data.msg + ')')
        })
        .error(function () {
          log(arguments)
        })
      }

      $scope.view_catalog_item = function () {
        $('#item_content_view').load(thx_util.item_url + '/' + $scope.input_item_gtin)
      }

    })



    thx_app.controller('thx_party_controller', function($scope, $http, thx_util) {

      $scope.page = 0

      $scope.showPartyDetail = function (party) {
        log('showPartyDetail called for gln ' + party.gln)
        if (party && party.json && party.json.registryPartyDataDumpDetail) {
          $result_dialog.html(prettyPrint(party.json.registryPartyDataDumpDetail.registryParty)).dialog('open')
        }
      }

      $scope.page = 0

      $scope.list_parties = function (pageIncrement) {
        if (pageIncrement) {
          $scope.page += pageIncrement
        }
        else {
          $scope.page = 0
        }
        log('list_parties called with page increment ' + pageIncrement)

        showBusy('Fetching party list...')
        $http.get(thx_util.parties_url, { 
          params: { page: $scope.page }
        })
        .success(function (parties) {
          $scope.parties = _.map(parties, function (party) {
            party.created_ts = (new Date(party.created_ts)).toLocaleString()
            party.modified_ts = (new Date(party.modified_ts)).toLocaleString()
            return party
          })
          log('found ' + $scope.parties.length + ' parties')
          hideBusy()
        })
        .error(function () {
          hideBusy()
          $error_dialog.html('An error occurred -- please try again').dialog('open')
        })
      }

      $scope.post_parties = function () {
        $http.post(thx_util.parties_url, $scope.party_content_post + '\n\n')
        .success(function (data) {
          log(data)
          alert('XML uploaded successfully (' + data + ')')
        })
        .error(function () {
          log(arguments)
        })
      }

      $scope.view_party = function () {
        $('#party_content_view').load(thx_util.party_url + '/' + $scope.input_party_gln)
      }

    })



    thx_app.controller('thx_debug_controller', function($scope, $http, thx_util) {
      $scope.page = 0
      $scope.per_page = 10
      $scope.more_items = false
      $scope.total_item_count = 0
      $scope.item_range_start = 0 
      $scope.item_range_end   = 0   

      $scope.reset_log_search = function () {
        delete $scope.input_log_regex
        delete $scope.input_log_level
        delete $scope.input_include_total_count
        delete $scope.input_action_type
        delete $scope.input_startdate
        delete $scope.input_enddate
        delete $scope.input_username
        delete $scope.input_duration
        
        delete $scope.fileLogs
        delete $scope.total_item_count
        delete $scope.input_per_page
        delete $scope.page
        delete $scope.more_items
        delete $scope.total_item_count
        delete $scope.item_range_start 
        delete $scope.item_range_end   
      }
      
      $scope.list_fileLogs = function (pageIncrement) {
        pageIncrement = Math.floor(pageIncrement)
        console.log('list_fileLogs pageIncrement=' + pageIncrement)

        $scope.search_params = $scope.search_params || {} // create new if needed
        $scope.input_per_page = $scope.input_per_page || 10


        if (pageIncrement) {
          $scope.page += pageIncrement              // note that we don't allow per_page to be changed when paging
          $scope.search_params.page = $scope.page
          $scope.search_params.include_total_count = false // don't recount when paging
        }
        else { // only reread search params from form and reset counts if not paging
          $scope.page = 0
          $scope.total_item_count = 0
          $scope.per_page = $scope.input_per_page || 10
          $scope.search_params = {
              page                : $scope.page 
            , per_page            : $scope.per_page
            , include_total_count : $scope.input_include_total_count

            , regex               : $scope.input_log_regex
            , level               : $scope.input_log_level
            , date_start          : $scope.input_startdate
            , date_end            : $scope.input_enddate
            , username            : $scope.input_username
            , duration            : $scope.input_duration
          }
        }
        
        console.log('logs url=' + thx_util.logs_url+ ", $scope.search_params=" +JSON.stringify($scope.search_params) )
        
        showBusy('Fetching fileLogs list...')

        $http.get(thx_util.logs_url, { 
          params: $scope.search_params
        })
        .success(function (fileLogs) {
          console.log( JSON.stringify(fileLogs) )

          //$scope.page = 4
          if (fileLogs.collection.total_item_count) $scope.total_item_count = fileLogs.collection.total_item_count
          if (fileLogs.collection.item_range_start) $scope.item_range_start = fileLogs.collection.item_range_start 
          if (fileLogs.collection.item_range_end)   $scope.item_range_end   = fileLogs.collection.item_range_end   

          if (fileLogs.collection.item_count) {
	          $scope.fileLogs = _.map(fileLogs.collection.items, function (fileLog) {
	            fileLog.timestamp = (new Date(fileLog.timestamp)).toLocaleString()
	            return fileLog
	          })
	          console.log('found ' + $scope.fileLogs.length + ' rows')
	          console.log('Per page ', $scope.per_page, ' rows')
	          console.log('page ', $scope.page)
	          $scope.more_items = ($scope.fileLogs.length == $scope.per_page)
//	          $scope.more_items = (fileLogs.length == $scope.per_page)
          } else {
            if ($scope.page > 0) $scope.page--
            $scope.more_items = false
            delete $scope.fileLogs
            delete $scope.total_item_count
            delete $scope.input_per_page
//            delete $scope.page
            delete $scope.more_items
          }
          hideBusy()
        })
        .error(function () {
          hideBusy()
          $error_dialog.html('An error occurred -- please try again').dialog('open')
        })
      }

    })



    thx_app.directive('gdsnSubscriptions', function (thx_util) {
      log('directive gdsnSubscriptions')
      return {
        restrict: 'EA'
        , replace: true
        , templateUrl: 'gdsn_sub_list_template.html'
        //, scope: { test_ts: '=timestamp' }
        //, scope: false // default; uses enclosing controller scope
        , scope: true // can read enclosing controller scope, not only set local dir scope (can still set scope.$parent)
        , link: function (scope, element, attrs) {
            log('link')
            log('link attrs')
            log(attrs)

            //scope.$parent.subscriber = element.attr('default-subscriber')

            scope.$parent.subscriber = attrs.defaultSubscriber
            log('scope.subscriber ' + scope.subscriber)
            scope.dir_link_test = 'dir_link_test_value'

            log('scope')
            log(scope)
          }
        , controller: function ($scope) {
            $scope.dir_controller_test = 'dir_controller_test_value'
          }
      }
    })
  })()
</script>
<script>
  //$(function () {
  (function () {

    $('#welcome').load('welcome.html')
    $('#find_not_pub').load('find_not_published.html')

    if (app.debug) {
      $('#debug_tab').append('<div>Timestamp: ' + app.ts + '</div>')
      $('#tabs ul').append('<li><a href="#debug_tab">Debug</a></li>')
      //$('#snoop').load('snoop')
    }

    $('#tabs').tabs() //{ collapsible: true, active: false })

    var tab_names = {
      main  : 0, 
      msg   : 1, 
      party : 2,
      items : 3, 
      pub   : 4, 
      sub   : 5, 
      debug : 6
    }
    $('#tabs').tabs('option', 'active', tab_names['items']) 

    $('#progressbar').progressbar({ value: false })

    if ('undefined' != typeof(createTicker)) { // uncoment ticker.js to enable ticker test
      $('#debug_tab').append('<div>Test ticker<span id="ticker"></span></div>')
      log('ticker setup')
      var ticker = createTicker('ticker')
      ticker.start()
    }

  })()

$(function() {
	$( "#log_datepicker_start" ).datepicker();
	$( "#log_datepicker_end" ).datepicker();
});

</script>
<!--<script src="js/ticker.js"></script>-->
</body>
</html>
