<!DOCTYPE html>
<html lang="us">
<head>
  <!-- Version $URL: $ -->
  <meta charset="utf-8">
  <title>Catalog Services Dashboard</title>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
  <link rel="stylesheet" href="css/styles_new.css" />
  <link rel="stylesheet" href="jqui/jquery-ui-1.10.4.custom.css" />

  <style type="text/css">
    .clickable { 
      cursor: pointer; 
      border: #ccc dotted 1px; 
    }
    .selected {
      border: #ccf solid 1px; 
    }
    td {
      text-align: center;
    }
  </style>

  <style type="text/css">
    #progressbar .ui-progressbar-value {
      background-color:#ccf;
    }
    p.vert_spacer {
        height:20px
    }
    div.blue_box {
      border-style: solid;
      border-width: 1px;
      border-color: blue;
      font-family: sans-serif;
      color: blue;
    }
  </style>

  <script src="js/jp-pretty-print-101.js"></script>
  <script src="js/jquery-1.10.2.js"></script>
  <script src="jqui/jquery-ui-1.10.4.custom.js"></script>
  <script src="js/underscore-1.5.2.js"></script>
  <script src="js/angular-1.2.2.js"></script>
  <script src="js/file/angular-file-upload.js"></script>
  
</head>
<body ng-app="thx_app">

<script type="text/ng-template" id="gdsn_sub_list_template.html">
  <div style="border-style:solid;border-width:1px;border-color:blue">
    <div>GDSN Widget</div>
    <div ng-if="data" style="border-style:solid;border-width:1px;border-color:green">
      <div ng-if="selectedSub"><textarea rows="6" cols="60" disabled ng-bind="selectedSub"></textarea></div>
      <div>Subscriptions for subscriber {{data.subscriber}} as of <span ng-bind="timestamp"/>:</div>
      <div class="clickable" ng-repeat="sub in data.subscriptions" ng-click="selectSubscription(sub)">
        <span>{{$index + 1}}. Publisher/Data Source: {{sub.dsName}} (GLN {{sub.ds}})</span>
      </div>
      <div>Data URL: <a ng-href="{{data.url}}">{{data.url}}</a></div>
      <div>Timestamp: <span>{{timestamp}}</span></div>
    </div>
    <div>thx_controller_test: <span>{{thx_controller_test}}</span></div>
    <div>dir_controller_test: <span>{{dir_controller_test}}</span></div>
    <div>dir_link_test: <span>{{dir_link_test}}</span></div>
  </div>
</script>

<div id="tabs">

  <div>
    <h2>Catalog Services Dashboard</h2>
    <!-- Version $URL: $ -->
  </div>

  <ul>
    <li><a href="#main_menu">Main Menu</a></li>
    <li><a href="#msg_tab">Messages</a></li>
    <li><a href="#party_tab">Trading Parties</a></li>
    <li><a href="#item_tab">Catalog Items</a></li>
    <li><a href="#pub_tab">Publication</a></li>
    <li><a href="#sub_tab">Subscription</a></li>
  </ul>

  <div id="main_menu">
    <div id="main_menu-quicklinks">
      <h2>Welcome to Catalog Services</h2>
      <h3>Quick Links</h3>

      <h4>Sample Web Client</h4>
      <p><a href="/api_sample_client.html" target="_blank">Sample API Test Client</a></p>

      <h4>API Docs</h4>
      <p><a href="/cs_api/1.0/login"           target="_blank">Login Endpoint Docs</a></p>
      <p><a href="/cs_api/1.0/items"           target="_blank">Items Endpoint Docs</a></p>
      <p><a href="/cs_api/1.0/subscribed"      target="_blank">Subscriber Endpoint Docs</a></p>
      <p><a href="/cs_api/1.0/lookup_allergen" target="_blank">Allergen Code Lookup Endpoint Docs</a></p>
      <p><a href="/cs_api/1.0/lookup_country"  target="_blank">Country Code Lookup Endpoint Docs</a></p>
      <p><a href="/cs_api/1.0/lookup_nutrient" target="_blank">Nutrient Code Lookup Endpoint Docs</a></p>

      <h4>Examples</h4>
      <p>(Login: test / testAdmin)</p>
      <p>(Login: bp_cps / bp_cpsAdmin)</p>
      <p><a href="/cs_api/1.0/login?user=test&pass=testAdmin"      target="_blank">Login Endpoint Example: test/testAdmin</a></p>
      <p><a href="/cs_api/1.0/items?xml_text=uniformRes&json=true" target="_blank">Items Endpoint Example: XML Text Search for 'uniformRes'</a></p>
      <p><a href="/cs_api/1.0/items?msg_id_text=ECCNET&json=true"  target="_blank">Items Endpoint Example: Latest ECCnet Items by Msg ID</a></p>
      <p><a href="/cs_api/1.0/items?gtin=279&tm=840&json=true"     target="_blank">Items Endpoint Example: GTIN with 279, TM 840</a></p>
      <p><a href="/cs_api/1.0/items?page=2&per_page=10&json=true"  target="_blank">Items Endpoint Example: Most Recently Modified, 21 - 30</a></p>
      <p><a href="/cs_api/1.0/subscribed/00038000105234"           target="_blank">Subscriber Endpoint Example: GTIN 00038000105234</a></p>
      <p><a href="/cs_api/1.0/subscribed/00067000004650?transform=server&lang=fr" target="_blank">Subscriber Endpoint Example: bp_cps fr item</a></p>
      <p><a href="/cs_api/1.0/lookup_allergen?lang=es"           target="_blank">Allergen Code Lookup Endpoint Example: List by lang</a></p>
      <p><a href="/cs_api/1.0/lookup_allergen?lang=en&code=AC"   target="_blank">Allergen Code Lookup Endpoint Example: AC/en</a></p>
      <p><a href="/cs_api/1.0/lookup_country?lang=en"            target="_blank">Country Code Lookup Endpoint Example: List by lang</a></p>
      <p><a href="/cs_api/1.0/lookup_country?lang=es&code=840"   target="_blank">Country Code Lookup Endpoint Example: 840/es</a></p>
      <p><a href="/cs_api/1.0/lookup_nutrient?lang=en"           target="_blank">Nutrient Code Lookup Endpoint Example: List by lang</a></p>
      <p><a href="/cs_api/1.0/lookup_nutrient?lang=en&code=VITC" target="_blank">Nutrient Code Lookup Endpoint Example: VITC/en</a></p>
    </div>
    <div id="welcome">[Loading welcome.html]</div>
  </div>

  <div id="msg_tab" ng-controller="thx_msg_controller">
    <div id="msg_accordion">

      <div>Search Messages</div>
      <div>
        <br/>
        <button ng-if="page > 0" ng-click="list_messages(-1)">Prev</button>
        <button ng-if="messages && messages.length == 10" ng-click="list_messages(1)">Next</button>
        <div ng-if="messages" style="border-style:solid;border-width:1px;border-color:green">
          <table>
            <tr>
              <th>ID</th>
              <th>Sender</th>
              <th>Receiver</th>
              <th>Created</th>
              <th>Modified</th>
            </tr>
            <tr class="clickable" ng-repeat="msg in messages" ng-click="showMessageDetail(msg)">
              <td>{{msg.msg_id}}</td>
              <td>{{msg.sender}}</td>
              <td>{{msg.receiver}}</td>
              <td>{{msg.created_ts}}</td>
              <td>{{msg.modified_ts}}</td>
              <!-- Raw Data: '{{msg}}' -->
            </tr>
          </table>
        </div>
        <button ng-if="!messages" ng-click="list_messages()">Load Messages</button>
      </div>

      <div>View Message</div>
      <div>
        Message ID:
        <br/><input type="text" ng-model="view_msg_id"/>
        <br/><button ng-click="view_msg()">View</button>
        <br/><textarea rows="6" cols="100" id="msg_content_view"></textarea>
        <br/><span ng-if="view_msg_id">[<a ng-href="/cs_api/1.0/msg/{{view_msg_id}}">Link to message {{view_msg_id}}</a>]</span>
      </div>

      <div>Post Message</div>
      <div>
        <div ng-controller="thx_file_controller">
          <input type="file" ng-file-select="onFileSelect($files, 'msg_url')"></input>
          <button ng-click="uploadFile('msg_url')">Upload File</button>
        </div>
        <div>
          <br/><textarea rows="6" cols="100" ng-model="msg_content_post"></textarea>
          <br/><button ng-click="post_msg()">Post</button>
        </div>
      </div>

      <div>JSON Data</div>
      <div>
        <button ng-click="list_msg()">Update</button>
        <pre id="message_list"></pre>
      </div>

    </div>
  </div> <!-- end msg_tab -->

  <div id="party_tab" ng-controller="thx_party_controller">
    <div id="party_accordion">

      <div>Search Trading Parties</div>
      <div>
        <br/>
        <button ng-if="page > 0" ng-click="list_parties(-1)">Prev</button>
        <button ng-if="parties && parties.length == 10" ng-click="list_parties(1)">Next</button>
        <div ng-if="parties" style="border-style:solid;border-width:1px;border-color:green">
          <table>
            <tr>
              <th>Name</th>
              <th>GLN</th>
              <th>Country</th>
              <th>Data Pool</th>
              <th>Created</th>
              <th>Modified</th>
            </tr>
            <tr class="clickable" ng-repeat="party in parties" ng-click="showPartyDetail(party)">
              <td>{{party.name}}</td>
              <td>{{party.gln}}</td>
              <td>{{party.country}}</td>
              <td>{{party.data_pool_gln}}</td>
              <td>{{party.created_ts}}</td>
              <td>{{party.modified_ts}}</td>
              <!-- Raw Data: '{{party}}' -->
            </tr>
          </table>
        </div>
        <button ng-if="!parties" ng-click="list_parties()">Load Parties</button>
      </div>

      <div>Trading Party Details</div>
      <div>
        GLN:
        <br/><input type="text" ng-model="input_party_gln"/>
        <br/><button ng-click="view_party()">View</button>
        <br/><textarea rows="6" cols="100" id="party_content_view"></textarea>
        <br/><span ng-if="input_party_gln">[<a ng-href="/cs_api/1.0/party/{{input_party_gln}}?download=true">Download link to catalog party {{input_party_gln}}</a>]</span>
      </div>

      <div>Post Trading Parties RPDD File</div>
      <div>
        <div ng-controller="thx_file_controller">
          <input type="file" ng-file-select="onFileSelect($files, 'parties_url')"></input>
          <button ng-click="uploadFile('parties_url')">Upload File</button>
        </div>
        <div>
          <br/>Or paste CIN XML:
          <br/><textarea rows="6" cols="100" ng-model="party_content_post"></textarea>
          <br/><button ng-click="post_parties()">Post XML</button>
        </div>
      </div>

    </div>
  </div> <!-- end party_tab -->

  <div id="item_tab" ng-controller="thx_item_controller">
    <div id="item_accordion">

      <div>Search Catalog Items</div>
      <div>
        <span>GTIN          <input type="text" ng-model="input_item_gtin" size="16" placeholder="99999999999999"></input></span>
        <span>Provider GLN  <input type="text" ng-model="input_item_provider" size="15" placeholder="1100001011292"></input></span>
        <span>Recipient GLN <input type="text" ng-model="input_item_recipient" size="15" placeholder="0625199000015"></input></span>
        <span>TM Country    <input type="text" ng-model="input_item_tm" size="3" placeholder="840"></input></span>
        <span>TM Sub        <input type="text" ng-model="input_item_tm_sub" size="5" placeholder="US-CA"></input></span>
        <p/>
        <span>XML Regex     <input type="text" ng-model="input_item_xml_text" size="30" placeholder="foodAndBev"></input></span>
        <span>Msg ID Regex  <input type="text" ng-model="input_item_msg_id_text" size="30" placeholder="CIN_IN_"></input></span>
        <button ng-click="list_items(0)">Search</button>
        <button ng-click="reset_search()">Reset</button>
        <p/>
        <div ng-if="items">
          <p>
            <button ng-if="page > 0" ng-click="list_items(-1)">Prev</button>
            <button ng-if="more_items" ng-click="list_items(1)">Next</button><span ng-if="!(more_items)">No more items to display</span>
            <div>Page:<span>{{ page + 1 }}</span></div>
          </p>
          <table>
            <tr>
              <th>GTIN</th>
              <th>Provider</th>
              <th>TM Country</th>
              <th>TM Sub</th>
              <th>Recipient</th>
              <th>Child Count</th>
              <th>Created</th>
              <th>Modified</th>
              <th>CIN Message</th>
              <!--<th>HREF</th>-->
            </tr>
            <tr class="clickable" ng-repeat="item in items" ng-click="showItemDetail(item)">
              <td>{{item.gtin}}</td>
              <td>{{item.provider}}</td>
              <td>{{item.tm}}</td>
              <td>{{item.tm_sub}}</td>
              <td>{{item.recipient}}</td>
              <td>{{item.child_gtins && item.child_gtins.length}}</td>
              <td>{{item.created_ts}}</td>
              <td>{{item.modified_ts}}</td>
              <td>{{item.msg_id}}</td>
              <!--<td><a ng-href="{{item.href}}" target="_blank">XML</a></td>-->
              <!-- Raw Data: '{{item}}' -->
            </tr>
          </table>
          <div ng-if="selectedItem" class="blue_box">
            <p>Selected GTIN: {{selectedItem.gtin}}</p>
            <p><a ng-href="{{selectedItem.href}}" target="_blank">View XML for catalog item {{selectedItem.gtin}}</a></p>
            <p><a ng-href="{{selectedItem.href}}?download=true">Download XML for catalog item {{selectedItem.gtin}}</a></p>
            <p><a ng-href="{{selectedItem.href}}?json=true" target="_blank">View JSON for catalog item {{selectedItem.gtin}}</a></p>
            <p><a ng-href="{{selectedItem.href}}?json=true&download=true">Download JSON for catalog item {{selectedItem.gtin}}</a></p>
            <p><a ng-href="{{selectedItem.href}}?pp=true" target="_blank">View PrettyPrint for catalog item {{selectedItem.gtin}}</a></p>
            <p>Child GTINs: {{selectedItem.child_gtins.join(' ')}}</p>
          </div>
        </div> <!-- end if items -->
        <!--<div>Results per page: <input ng-model="input_per_page" size="3"></input></div>-->
      </div>

      <div>Catalog Item Details</div>
      <div>
        GTIN:
        <br/><input type="text" ng-model="input_item_gtin"/>
        <br/><button ng-click="view_catalog_item()">View</button>
        <br/><textarea rows="6" cols="100" id="item_content_view"></textarea>
        <br/><span ng-if="input_item_gtin">[<a ng-href="/cs_api/1.0/items/{{input_item_gtin}}?download=true">Download link to catalog item {{input_item_gtin}}</a>]</span>
      </div>

      <div>Post Catalog Items</div>
      <div>
        <div ng-controller="thx_file_controller">
          <input type="file" ng-file-select="onFileSelect($files, 'item_url')"></input>
          <button ng-click="uploadFile('item_url')">Upload File</button>
        </div>
        <div>
          <br/>Or paste CIN XML:
          <br/><textarea rows="6" cols="100" ng-model="item_content_post"></textarea>
          <br/><button ng-click="post_catalog_items()">Post XML</button>
        </div>
      </div>

    </div>
  </div> <!-- end item_tab -->

  <div id="pub_tab" ng-controller="thx_pub_controller">
    <div id="pub_accordion">

      <div>Search Publications</div>
      <div id="pub_list">
        <div>
          <input type="text" ng-model="publisher"></input>
          <input type="button" ng-click="getPublications(publisher)" value="Get Publications"></input>
          <div ng-if="data.publisher">
            <div>Publications for ITN publisher {{data.publisher}} as of <span ng-bind="timestamp"/>:</div>
            <div class="clickable" ng-repeat="pub in data.publications" ng-click="showPubDetail(pub)">
              <span>{{$index + 1}}. Published to GLN: {{pub.publishToGLN}}
                <br/>Item GTIN: {{pub.gtin}}
                <br/>Item TM/TMSub: {{pub.tm}}/{{pub.tmsub}}
              </span>
            </div>
          </div>
          <div ng-if="data.url">Data URL: <a ng-href="{{data.url}}">{{data.url}}</a></div>
        </div>
      </div>

      <div>Find Unpublished Items</div>
      <div id="find_not_pub">Loading...</div>

      <div>Publish Item to Subscriber GLN</div>
      <div id="pub_util">
        <form id="pub_form">
            <p>* Publisher GLN:<br/><input type="text" name="ds" ng-model="publisher"/></p>
            <p>* Product GTIN:<br/><input type='text' name='gtin'/></p>
            <p>* Product TM numeric ISO code (e.g. '840'):<br/><input type='text' name='tm'/></p>
            <p>  Product TM subdivision alpha code (e.g. 'US-CA'):<br/><input type='text' name='tms'/></p>
            <p>* Publish-To GLN:<br/><input type='text' name='dr'ng-model="subscriber"/></p>
            <p>Initial load<br/><input type='checkbox' name='il'/></p>
            <button ng-click="publish_item()">Submit</button>
            <div id="pub_result">Loading...</div>
        </form>
      </div>

    </div>
  </div> <!-- end pub_tab -->

  <div id="sub_tab" ng-controller="thx_sub_controller">
    <div id="sub_accordion">
      <div>Fetch Subscribed Items</div>
      <div>

        <div>
          <form id="sub_form">
            <table>
              <tr>
                <td>
                  <p>GTIN<br/><input id="input_gtin" value="00038000105234" size="40"></input></p>
                  <p>Provider GLN<br/><input id="input_provider" value="" size="40"></input></p>
                </td>
                <td>
                  <p>Target Market Country Code<br/><input id="input_tm" value="" size="40"></input></p>
                  <p>Target Market Subdivision Code<br/><input id="input_tm_sub" value="" size="40"></input></p>
                </td>
              </tr>
              <tr>
                <td>
                  <p><input id="input_include_children" type="checkbox"></input>  Include Children</p>
                  <p><input id="input_include_parents" type="checkbox"></input>   Include Parents</p>
                  <p><input id="input_food_only" type="checkbox"></input>         Only items with Food/Bev Info </p>
                </td>
                <td>
                  <p>Data Transform <select name="trans_type" id="input_server_transform"><option value="">None</option><option value="client">Client</option><option value="server">Server</option></select></p>
                  <p><input id="input_multi_gtin" type="checkbox"></input>        Multi: allow multiple items with same GTIN</p>
                </td>
              </tr>
              <tr>
                <td>
                  <p><button id="btn_fetch" ng-click="getSubscribedItems()">Fetch Items</button></p>
                </td>
                <td>
                  <p><button id="btn_fetch_hide" ng-click="resetSubscribedItems()">Clear Results</button></p>
                </td>
              </tr>
            </table>
          </form>
        </div>

        <p id="sub_error" ng-if="sub_error">{{ sub_error }}</p>
        <div id="sub_result" ng-if="subscribed_items">
          <p id="sub_msg" ng-if="sub_msg">{{ sub_msg }}</p>
          <div ng-repeat="item in subscribed_items">
            <span>Item {{ item.href }} ({{ item.fetch_type }}):</span>
            <br/><textarea rows="6" cols="120">{{ item }}</textarea>
          </div>
        </div>

        <script src="js/bp_cs_client.js"></script>
      </div> <!-- end sub_client -->

      <div>Search Subscriptions</div>
      <div>
        <input type="text" ng-model="subscriber"></input>
        <input type="button" ng-click="getSubscriptions(subscriber)" value="Get Subscriptions"></input>
        <div gdsn-subscriptions default-subscriber="1100001011292"/>
      </div>

    </div> <!-- end sub_accordion -->
  </div> <!-- end sub_tab -->

</div><!-- end tabs -->

<div id="debug_tab">
  <div>Model values:</div>
  <div>Subscriber: {{subscriber}}</div>
  <div>Publisher: {{publisher}}</div>
  <div>View Message ID: {{view_msg_id}}</div>
  <div>Message post content: <textarea disabled>{{msg_content_post}}</textarea></div>
  <div id="snoop">Loading...</div>
</div>

<div id="footer_area">
  <p>Copyright &copy; 2014</p>
</div>

<div id="result_dialog">Loading...</div>

<div id="error_dialog">An error occurred!</div>

<div id="progress_dialog">
    <p class="vert_spacer" ></p>
    <div id="progressbar"></div>
</div>

<script>
  (function() {

    var log = function (msg) {
      if (console && console.log) console.log(msg)
      else alert(msg)
    }

    app = {
      version: "1.0"
      , ts: Date.now()
      , debug: true
      , api: '/cs_api/1.0'
    }

    var $party_accordion = $("#party_accordion")
    $party_accordion.accordion({
        heightStyle: 'content',
        collapsible: true
    })

    var $item_accordion = $("#item_accordion")
    $item_accordion.accordion({
        heightStyle: 'content',
        collapsible: true
    })

    var $pub_accordion = $('#pub_accordion')
    $pub_accordion.accordion({
        heightStyle: 'content',
        collapsible: true
    })

    var $sub_accordion = $('#sub_accordion')
    $sub_accordion.accordion({
        heightStyle: 'content',
        collapsible: true
    })

    var $msg_accordion = $('#msg_accordion')
    $msg_accordion.accordion({
        heightStyle: 'content',
        collapsible: true
    })

    var $result_dialog = $('#result_dialog')
    $result_dialog.dialog({
      autoOpen: false
      , title: 'Selected Results'
      , width: 1000
      , modal: true
      , buttons: { OK: function() { $result_dialog.dialog('close') } }
    })
    
    var $error_dialog = $('#error_dialog')
    $error_dialog.dialog({
      autoOpen: false
      , title: 'Error'
      , width: 500
      , modal: true
      , buttons: { OK: function() { $error_dialog.dialog('close') } }
    })
    
    var $progress_dialog = $('#progress_dialog')
    $progress_dialog.dialog({
      autoOpen: false
      , width: 700
      , modal: true
    })
    
    function showBusy(title) {
      log('busy 2: ' + title)
      $progress_dialog.dialog('option', 'title', title)
      $progress_dialog.dialog('open')
    }

    function hideBusy() {
      setTimeout(function () {
        $progress_dialog.dialog('close')
      }, 500)
    }

    var thx_app = angular.module('thx_app', ['angularFileUpload'])

    thx_app.factory('thx_util', function () {
      return {
          sub_url     : app.api + '/subscriptionList'
        , pub_url     : app.api + '/publicationList'
        , msg_url     : app.api + '/msg'
        , item_url    : app.api + '/items'
        , party_url   : app.api + '/party'
        , parties_url : app.api + '/parties'
      }
    })

    thx_app.controller('thx_file_controller', function($scope, $upload, thx_util) {
      $scope.onFileSelect = function($files, url) {
        $scope[url + '_file'] = $files && $files[0]
      }
      $scope.uploadFile = function(url) {
          var file = $scope[url + '_file']
          if (!file) return
          $scope.upload = $upload.upload({
            url: thx_util[url], // 'cs_api/1.0/items',
            // method: POST or PUT,
            // headers: {'headerKey': 'headerValue'},
            // withCredentials: true,
            //data: {myObj: $scope.myModelObj},
            file: file,
          })
          .progress(function(evt) {
            log('percent: ' + parseInt(100.0 * evt.loaded / evt.total));
          })
          .success(function(data, status, headers, config) {
            // file is uploaded successfully
            log(data);
            alert('File uploaded successfully (' + data.msg + ')')
          })
          .error(function(msg) {
            log('ajax upload file failed')
            log(arguments)
            $error_dialog.html('An error occurred: ' + msg).dialog('open')
          })
      }
    })

    thx_app.controller('thx_sub_controller', function($scope, $http, thx_util) {
      $scope.timestamp = 'n/a'
      $scope.thx_controller_test = 'thx_controller_test_value'

      $scope.selectSubscription = function (sub) {
        log('selectSubscription')
        log(sub)
        $scope.selectedSub = JSON.stringify(sub)
        //$scope.selectedSub = sub
      }

      $scope.getSubscriptions = function () {
        if (/\d{13}/.test($scope.subscriber)) {
          //$http.get(thx_util.sub_url, { 
          $http.jsonp('http://plt-gdsn01.itradenetwork.com:8080/gdsn-server/api/getSubscriptionList' , {
            params: { subscriber: $scope.subscriber, callback: 'JSON_CALLBACK' }
          })
          .success(function (data) {
            $scope.data = data
            $scope.timestamp = data.timestamp
            $scope.selectedSub = null
          })
          .error(function () {
            log(arguments)
          })
        }
        else {
          alert('Error: invalid gln, should be 13 digits')
        }
      }

      $scope.resetSubscribedItems = function () {
        console.log('resetSubscribedItems')
        $scope.sub_error = null
        $scope.subscribed_items = null
      }

      $scope.getSubscribedItems = function () {
        console.log('getSubscribedItems')

        var gtin = $('#input_gtin').val()
        if (!gtin) return alert('GTIN is required')

        var provider  = $('#input_provider').val()
        var tm        = $('#input_tm').val()
        var tm_sub    = $('#input_tm_sub').val()
        var transform = $('#input_server_transform').val()
        log('transform param: ' + transform)
        var children  = $('#input_include_children').prop('checked')
        var parents   = $('#input_include_parents').prop('checked')
        var multi     = $('#input_multi_gtin').prop('checked')
        var food     = $('#input_food_only').prop('checked')

        var url = app.api + '/subscribed/' + gtin
        if (provider) url += '/' + provider
        if (tm)       url += '/' + tm
        if (tm_sub)   url += '/' + tm_sub
        log('url: ' + url)

        var form_serialize = $('#sub_form').serialize()
        log('sub form form_serialize: ' + form_serialize)

        showBusy('Fetching subscribed items...')

        //$http.jsonp(url, {
        //$http.get('/err', {
        $http.get(url, {
          params: { 
              children: children
            , parents: parents
            , multi: multi
            , transform: transform
            , food: food
            //, callback: 'JSON_CALLBACK'
          }
        })
        .success(function (data) {
          hideBusy()
          if (data.collection.error) {
            $scope.subscribed_items = null // clear previous results to avoid confusion
            var e = data.collection.error
            $scope.sub_error = 'Error: ' + e.title + ' (' + e.message + ')'
            $error_dialog.html('An error occurred: ' + e.title + ' (' + e.message + ')')
            if (data.collection.links) {
              var links = data.collection.links
              //if (links.length) $scope.sub_msg += ('<p>Please specify more criteria as shown below:</p>')
              //links.forEach(function (link) {
                //$scope.sub_msg += ('<p><a target="new" href="' + link.href + '">' + link.href + '</a></p>')
              //})
            }
            return
          }
          var items = data.collection.items || []
          $scope.sub_msg = 'Item count: ' + items.length
          $scope.sub_error = null

          items = items.map(function (item) {
            if (transform == 'client') item = cs_client.transform(item)
            log('appending item ' + item.gtin)
            return item
          })
          $scope.subscribed_items = items
        })
        .error(function (msg) {
          log('ajax getSubscribedItems failed')
          log(arguments)
          $scope.sub_error = 'Error: ' + msg
          $scope.subscribed_items = null // clear previous results to avoid confusion
          hideBusy()
          $error_dialog.html('An error occurred: ' + msg).dialog('open')
        })
      }
    })

    thx_app.controller('thx_pub_controller', function($scope, $http, thx_util) {
      $scope.timestamp = 'n/a'
      $scope.thx_controller_test = 'thx_controller_test_value'

      $scope.showPubDetail = function (pub) {
        log('showPubDetail')
        log(pub)
        $scope.selectedPub = JSON.stringify(pub)
        //$scope.selectedPub = pub
      }

      $scope.getPublications = function (pubGln) {
        //$http.get(thx_util.pub_url, { 
        $http.jsonp('http://plt-gdsn01.itradenetwork.com:8080/gdsn-server/api/getPublicationList' , {
          params: { publisher: pubGln, callback: 'JSON_CALLBACK' }
        })
        .success(function (data) {
          $scope.data = data
          $scope.timestamp = data.timestamp
          $scope.selectedPub = null
        })
        .error(function () {
          log('ajax getPublications failed')
          log(arguments)
          alert('getPublications failed: ' + msg)
        })
      }

      $scope.publish_item = function () {
        var $pub_result = $('#pub_result')
        $pub_result.hide()
        var data = $('#pub_form').serialize()
        log('publishing item with data: ' + data)

        $http.get(app.api + '/publish?' + data, { 
          params: { page: $scope.page }
        })
        .success(function (messages) {
          alert('API Publish operation complete: ' + status)
          log('API Publish operation complete: ' + status)
          $pub_result.append('<div>Result: ' + status + '</div>')
          $pub_result.show()
          hideBusy()
        })
        .error(function () {
          log('ajax publish_item failed')
          log(arguments)
          hideBusy()
          $error_dialog.html('An error occurred -- please try again').dialog('open')
        })
      }

    })

    thx_app.controller('thx_msg_controller', function($scope, $http, thx_util) {

      $scope.page = 0

      $scope.list_messages = function (pageIncrement) {
        if (pageIncrement) {
          $scope.page += pageIncrement
        }
        else {
          $scope.page = 0
        }
        log('list_messages called with page increment ' + pageIncrement)

        showBusy('Fetching message list...')
        $http.get(thx_util.msg_url, { 
          params: { page: $scope.page }
        })
        .success(function (messages) {
          $scope.messages = _.map(messages, function (msg) {
            msg.created_ts = (new Date(msg.created_ts)).toLocaleString()
            msg.modified_ts = (new Date(msg.modified_ts)).toLocaleString()
            return msg
          })
          hideBusy()
        })
        .error(function () {
          hideBusy()
          $error_dialog.html('An error occurred -- please try again').dialog('open')
        })
      }

      $scope.showMessageDetail = function (msg) {
        log('showMessageDetail called for msg ' + msg.msg_id)
        $result_dialog.html(prettyPrint(msg)).dialog('open')
      }

      $scope.list_msg = function () {
        $('#message_list').load(thx_util.msg_url)
      }

      $scope.view_msg = function () {
        $('#msg_content_view').load(thx_util.msg_url + '/' + $scope.view_msg_id)
      }

      $scope.post_msg = function () {
        $http.post(thx_util.msg_url, $scope.msg_content_post + '\n\n')
        .success(function (data) {
          log(data)
        })
        .error(function () {
          log(arguments)
        })
      }

    })

    thx_app.controller('thx_item_controller', function($scope, $http, thx_util) {

      $scope.page = 0
      $scope.input_per_page = 10
      $scope.more_items = true

      $scope.showItemDetail = function (item) {
        log('showItemDetail called for gtin ' + item.gtin)
        $result_dialog.html(prettyPrint(item)).dialog('open')
        $scope.selectedItem = item
        //$scope.input_item_gtin = item.gtin
      }

      $scope.reset_search = function () {
        delete $scope.input_item_gtin
        delete $scope.input_item_provider
        delete $scope.input_item_recipient
        delete $scope.input_item_tm
        delete $scope.input_item_tm_sub
        delete $scope.input_item_xml_text
        delete $scope.input_item_msg_id_text
        delete $scope.items
        delete $scope.page
      }

      $scope.list_items = function (pageIncrement) {
        if (pageIncrement) {
          $scope.page += pageIncrement
        }
        else {
          $scope.page = 0
        }

        showBusy('Fetching item list...')
        $http.get(thx_util.item_url, { 
          params: { 
              page      : $scope.page 
            , per_page  : $scope.input_per_page
            , gtin      : $scope.input_item_gtin
            , provider  : $scope.input_item_provider
            , recipient : $scope.input_item_recipient
            , tm        : $scope.input_item_tm
            , tm_sub    : $scope.input_item_tm_sub
            , xml_text  : $scope.input_item_xml_text
            , msg_id_text  : $scope.input_item_msg_id_text
            , req_ts    : Date.now()
          }
        })
        .success(function (data) {
          var items = []
          try {
            items = data.collection.items || []
          }
          catch (e) {}

          if (items.length) {
            $scope.items = _.map(data.collection.items, function (item) {
              item.created_ts = (new Date(item.created_ts)).toLocaleString()
              item.modified_ts = (new Date(item.modified_ts)).toLocaleString()
              return item
            })
            $scope.selectedItem = null
            $scope.more_items = (items.length === $scope.input_per_page)
          }
          else {
            if ($scope.page > 0) $scope.page--
            $scope.more_items = false
          }
          hideBusy()
        })
        .error(function () {
          hideBusy()
          $error_dialog.html('An error occurred -- please try again').dialog('open')
        })
      }

      $scope.post_catalog_items = function () {
        $http.post(thx_util.item_url, $scope.item_content_post + '\n\n')
        .success(function (data) {
          log(data)
          alert('XML uploaded successfully (' + data + ')')
        })
        .error(function () {
          log(arguments)
        })
      }

      $scope.view_catalog_item = function () {
        $('#item_content_view').load(thx_util.item_url + '/' + $scope.input_item_gtin)
      }

    })

    thx_app.controller('thx_party_controller', function($scope, $http, thx_util) {

      $scope.page = 0

      $scope.showPartyDetail = function (party) {
        log('showPartyDetail called for gln ' + party.gln)
        if (party && party.json && party.json.registryPartyDataDumpDetail) {
          $result_dialog.html(prettyPrint(party.json.registryPartyDataDumpDetail.registryParty)).dialog('open')
        }
      }

      $scope.page = 0

      $scope.list_parties = function (pageIncrement) {
        if (pageIncrement) {
          $scope.page += pageIncrement
        }
        else {
          $scope.page = 0
        }
        log('list_parties called with page increment ' + pageIncrement)

        showBusy('Fetching party list...')
        $http.get(thx_util.parties_url, { 
          params: { page: $scope.page }
        })
        .success(function (parties) {
          $scope.parties = _.map(parties, function (party) {
            party.created_ts = (new Date(party.created_ts)).toLocaleString()
            party.modified_ts = (new Date(party.modified_ts)).toLocaleString()
            return party
          })
          log('found ' + $scope.parties.length + ' parties')
          hideBusy()
        })
        .error(function () {
          hideBusy()
          $error_dialog.html('An error occurred -- please try again').dialog('open')
        })
      }

      $scope.post_parties = function () {
        $http.post(thx_util.parties_url, $scope.party_content_post + '\n\n')
        .success(function (data) {
          log(data)
          alert('XML uploaded successfully (' + data + ')')
        })
        .error(function () {
          log(arguments)
        })
      }

      $scope.view_party = function () {
        $('#party_content_view').load(thx_util.party_url + '/' + $scope.input_party_gln)
      }

    })

    thx_app.directive('gdsnSubscriptions', function (thx_util) {
      log('directive gdsnSubscriptions')
      return {
        restrict: 'EA'
        , replace: true
        , templateUrl: 'gdsn_sub_list_template.html'
        //, scope: { test_ts: '=timestamp' }
        //, scope: false // default; uses enclosing controller scope
        , scope: true // can read enclosing controller scope, not only set local dir scope (can still set scope.$parent)
        , link: function (scope, element, attrs) {
            log('link')
            log('link attrs')
            log(attrs)

            //scope.$parent.subscriber = element.attr('default-subscriber')

            scope.$parent.subscriber = attrs.defaultSubscriber
            log('scope.subscriber ' + scope.subscriber)
            scope.dir_link_test = 'dir_link_test_value'

            log('scope')
            log(scope)
          }
        , controller: function ($scope) {
            $scope.dir_controller_test = 'dir_controller_test_value'
          }
      }
    })
  })()
</script>
<script>
  //$(function () {
  (function () {

    $('#welcome').load('welcome.html')
    $('#find_not_pub').load('find_not_published.html')

    if (app.debug) {
      $('#debug_tab').append('<div>Timestamp: ' + app.ts + '</div>')
      $('#tabs ul').append('<li><a href="#debug_tab">Debug</a></li>')
      $('#snoop').load('snoop')
    }

    $('#tabs').tabs() //{ collapsible: true, active: false })

    var tab_names = {
      main  : 0, 
      msg   : 1, 
      party : 2,
      items : 3, 
      pub   : 4, 
      sub   : 5, 
      debug : 6
    }
    $('#tabs').tabs('option', 'active', tab_names['items']) 

    $('#progressbar').progressbar({ value: false })

    if ('undefined' != typeof(createTicker)) { // uncoment ticker.js to enable ticker test
      $('#debug_tab').append('<div>Test ticker<span id="ticker"></span></div>')
      log('ticker setup')
      var ticker = createTicker('ticker')
      ticker.start()
    }

  })()
</script>
<!--<script src="js/ticker.js"></script>-->
</body>
</html>
