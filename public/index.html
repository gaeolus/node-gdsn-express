<!DOCTYPE html>
<html>
<head>
  <!-- Version $URL: http://svn.instill.com/repos/instill_dev/Catalog_Services/node-api-server/trunk/public/index.html $ -->
  <meta charset="utf-8">
  <title>Catalog Services Dashboard</title>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
  <link rel="stylesheet" href="css/styles_new.css" />
  <link rel="stylesheet" href="jqui/jquery-ui-1.10.4.custom.css" />

 <style>
    table
    {
      border-collapse: collapse;
    }

    table, th, td
    {
      border: 1px solid #e1e1e1;
    }

    th, td
    {
      padding: 6px;
    }

    thead
    {
      background-color: #fcfcfc;
    }
  </style>
  
</head>

<body ng-app="gdsn_app">

<div id="tabs">

  <div>
    <h2>Catalog Services Dashboard</h2>
    <div id="google_link"><a ng-href="/auth/login">Login with Google</a></div>
  </div>

  <p/>

  <ul>
    <li><a href="#main_menu">Main Menu</a></li>
    <li><a href="#msg_tab">Messages</a></li>
    <li><a href="#party_tab">Trading Parties</a></li>
    <li><a href="#item_tab">Catalog Items</a></li>
    <li><a href="#pub_tab">Publication</a></li>
    <li><a href="#sub_tab">Subscription</a></li>
  </ul>

  <div id="main_menu">
    <div id="main_menu-quicklinks">
      <h2>Welcome to Catalog Services</h2>
      <h3>Quick Links</h3>

      <h4>Sample Web Client</h4>
      <p><a href="/api_sample_client.html" target="_blank">Sample API Test Client</a></p>

      <h4>API Docs</h4>
      <p><a href="/docs/cs_api/1.0/login"           target="_blank">Login Endpoint Docs</a></p>
      <p><a href="/docs/cs_api/1.0/items"           target="_blank">Items Endpoint Docs</a></p>
      <p><a href="/docs/cs_api/1.0/subscribed"      target="_blank">Subscriber Endpoint Docs</a></p>

      <h4>Examples</h4>
      <p>(Login: test / testAdmin)</p>
      <p>(Login: bp_cps / bp_cpsAdmin)</p>
      <p><a href="/cs_api/1.0/login?user=test&pass=testAdmin"      target="_blank">Login Endpoint Example: test/testAdmin</a></p>
      <p><a href="/cs_api/1.0/items?xml_text=uniformRes&json=true" target="_blank">Items Endpoint Example: XML Text Search for 'uniformRes'</a></p>
      <p><a href="/cs_api/1.0/items?msg_id_text=ECCNET&json=true"  target="_blank">Items Endpoint Example: Latest ECCnet Items by Msg ID</a></p>
      <p><a href="/cs_api/1.0/items?gtin=279&tm=840&json=true"     target="_blank">Items Endpoint Example: GTIN with 279, TM 840</a></p>
      <p><a href="/cs_api/1.0/items?page=2&per_page=10&json=true"  target="_blank">Items Endpoint Example: Most Recently Modified, 21 - 30</a></p>
      <p><a href="/cs_api/1.0/items?unit_type=CASE&json=true"      target="_blank">Items Endpoint Example: Case Items, Most Recently Modified, 1 - 10</a></p>
      <p><a href="/cs_api/1.0/subscribed/00038000105234"           target="_blank">Subscriber Endpoint Example: GTIN 00038000105234</a></p>
      <p><a href="/cs_api/1.0/subscribed/00067000004650?transform=server&lang=fr" target="_blank">Subscriber Endpoint Example: bp_cps fr item</a></p>
    </div>
    <div id="welcome">[Loading welcome.html]</div>
  </div>


  <div id="msg_tab" ng-controller="gdsn_msg_controller">
    <div id="msg_accordion">

      <div>Search Messages</div>
      <div>
        <form id="msg_search_form">
          <span>Msg Id         <input type="text" size="40" ng-model="input_msg_id"     placeholder="RESP_52003" ></input></span>
          <span>Request Msg Id <input type="text" size="40" ng-model="input_req_msg_id" placeholder="RESP_52003" ></input></span>
          <span>Type
            <select ng-model="input_msg_type">
              <option value=""></option>
              <option value="basicPartyRegistration">BPR</option>
              <option value="registryCatalogueItem">RCI</option>
              <option value="catalogueItemPublication">CIP</option>
              <option value="catalogueItemSubscription">CIS</option>
              <option value="catalogueItemNotification">CIN</option>
              <option value="catalogueItemConfirmation">CIC</option>
              <option value="catalogueItemHierarchicalWithdrawal">CIHW</option>
              <option value="requestForCatalogueItemNotification">RFCIN</option>
              <option value="GDSNResponse">Responses</option>
            </select>
          </span>
          <span>Type     <input type="text" size="30" ng-model="input_msg_type_regex" placeholder="msg type"></input></span>
          <br />
          <span>Sender        <input type="text" size="13" ng-model="input_sender"         placeholder="1100001011292"></input></span>
          <span>Receiver      <input type="text" size="13" ng-model="input_receiver"       placeholder="0625199000015"></input></span>
          <span>XML           <input type="text" ng-model="input_xml_regex" size="30" placeholder="foodAndBev"></input></span>
          <span>Exception     <input type="text" ng-model="input_exc_regex" size="30" placeholder="Error"></input></span>
          <br />
          <span>Modified Start Date<input type="text" size="10" ng-model="input_modified_st_date"        placeholder="8/26/2014" datepicker></input></span>
          <span>Modified End Date  <input type="text" size="10" ng-model="input_modified_end_date"       placeholder="8/28/2014" datepicker></input></span>
          <span>Per Page           <input type="text" size="3"  ng-model="input_per_page" placeholder="99" value="99"></input></span>
          <br/>
          <button ng-click="list_messages()"   >Search</button>
          <button ng-click="reset_search()"    >Reset</button>
        </form>
      
        <br/>
        <div ng-if="messages" style="border-style:solid;border-width:1px;border-color:green" ng-controller="gdsn_msg_set_controller as rs_ctrl">

          <span>View filter:</span><input ng-model="query" type="text" size="22"/>

          <!-- searchresult 'rs_ctrl' controller set controls -->
          <label>Select</label>
          <button ng-click="rs_ctrl.toggleSelected(messages)" class="btn">Toggle</button>
          <label>Set name:</label> <input type="text" ng-model="rs_ctrl.newSetName" size="6" placeholder="new set"/>
          <button ng-click="rs_ctrl.createSet(messages)"        class="btn" ng-if="rs_ctrl.newSetName">Create Set</button>
          <button ng-click="rs_ctrl.validateSelected(messages)" class="btn"                           >Validate</button>
          <button ng-click="rs_ctrl.workflowSelected(messages)" class="btn"                           >Workflow</button>
          <button ng-click="rs_ctrl.reparseSelected(messages)"  class="btn"                           >Reparse</button>
          <button ng-click="rs_ctrl.sendSelected(messages)"     class="btn"                           >Send AS2</button>
          <button ng-click="rs_ctrl.archiveSelected(messages)"  class="btn"                           >Archive</button>

          <button ng-repeat="set in rs_ctrl.sets" 
            ng-click="rs_ctrl.recallSelected(messages, set.messages)" 
            title="reselect set '{{set.name}}' for actions"
            class="btn">{{set.name}} ({{set.count}})</button>
          
          <table width="100%">
            <tr>
              <th><input type="checkbox" ng-model="rs_ctrl.selectAll" ng-change="rs_ctrl.updateSelectAll(messages)"/></th>
              <th><a href="" ng-click="sortField = 'msg_id';         reverse = !reverse">Msg Id</a></th>
              <th><a href="" ng-click="sortField = 'version';        reverse = !reverse">Version</a></th>
              <th><a href="" ng-click="sortField = 'msg_type';       reverse = !reverse">Type</a></th>
              <th><a href="" ng-click="sortField = 'status';         reverse = !reverse">Status</a></th>
              <th><a href="" ng-click="sortField = 'sender';         reverse = !reverse">Sender</a></th>
              <th><a href="" ng-click="sortField = 'receiver';       reverse = !reverse">Receiver</a></th>
              <th>XML</th>
              <th><a href="" ng-click="sortField = 'created_ts';     reverse = !reverse">Created</a></th>
              <th><a href="" ng-click="sortField = 'modified_ts';    reverse = !reverse">Modified</a></th>
              <th><a href="" ng-click="sortField = 'content_length'; reverse = !reverse">Length</a></th>
            </tr>
            <tr ng-repeat="msg in messages | orderBy:sortField:reverse | filter:query">
              <td>
                <input type="checkbox" ng-model="msg.selected"/>
              </td>
              <td style="text-align: left;">
                <span><a ng-href="/cs_api/1.0/msg/{{msg.msg_id}}/{{msg.sender}}" target="_blank" title="View Raw XML">{{msg.msg_id}}</a></span>
              </td>
              <td><span class="clickable" ng-click="showMessageDetail(msg)">{{msg.version}}</span></td>
              <td style="text-align: left;">{{msg.msg_type}}</td>
              <td style="text-align: left;">
                  <span ng-if="msg.exception" class="clickable" ng-click="popupField(msg, 'exception')" title="Show Exception">{{msg.status}}</span>
                  <span ng-if="!msg.exception">{{msg.status}}</span>
                  <span ng-if="msg.request_msg_id"><a ng-href="/cs_api/1.0/msg/{{msg.request_msg_id}}/{{msg.receiver}}" target="_blank" title="View Request Message">req</a></span>
              </td>
              <td>{{msg.sender}}</td>
              <td>
                <span ng-if="msg.gdsn_repostable">{{msg.receiver}}</span>
                <span ng-if="!msg.gdsn_repostable"><a ng-href="/cs_api/1.0/gdsn-send/{{msg.msg_id}}/{{msg.sender}}" target="_blank" title="Send via AS2">{{msg.receiver}}</a></span>
              </td>
              <td>
                <span><a ng-href="/cs_api/1.0/{{config.gdsn_validate}}/{{msg.msg_id}}/{{msg.sender}}" target="_blank" title="Submit for GDSN Validation">Validate</a></span>
              </td>
                  
              <td><span class="clickable" ng-click="popupField(msg, 'xml')">{{msg.created_ts2}}</span></td>
              <td><span ng-if="msg.created_ts2 != msg.modified_ts2"><a ng-href="/cs_api/1.0/msg/history/{{msg.msg_id}}/{{msg.sender}}" target="_blank" title="View Message History">{{msg.modified_ts2}}</a></span></td>

              <!-- per msg utils -->
              <td>
                  <span>{{msg.xml_length}}</span>

                  <p ng-if="msg.gdsn_repostable">
                    <gdsn-workflow title="submit msg for dp workflow"><span>Workflow:</span></gdsn-workflow>
                  </p>

              </td>
            </tr>
          </table>
        </div>
        
        <!-- paging controls -->
        <p class="centered">
          <button ng-if="page > 1" ng-click="list_messages(-page)">First</button>
          <button ng-if="page > 0" ng-click="list_messages(-1)" >Prev</button>
            <span>Page:{{ page + 1 }}</span>
          <button ng-if="messages && messages.length == per_page" ng-click="list_messages(1)" >Next</button>
          <div class="centered">Displaying items <span>{{ item_range_start }}</span> to {{ item_range_end }}</div>
          <div class="centered" ng-if="!(more_items)">No more items to display</div>
        </p>
      </div>

      <div>Post Message</div>
      <div>
        <div ng-controller="gdsn_file_controller">
          <p class="desc">These forms will post messages to CS for party/item/pub/sub parsing and persistence, along with message archival.</p>
          <h4>File Upload</h4>
          <form id="file_upload_form">
            <input type="file" multiple="true" ng-file-select="onFileSelect($files, 'msg_url')"></input>
            <button ng-click="uploadFile('msg_url')">Upload File</button>
          </form>

          <p>Changes and new entries on other tabs may result:</p>
            <li>BPR and RPDD messages will create/update parties on the Trading Parties tab</li>
            <li>CIN messages will create/update items on the Catalog Items tab</li>
            <li>CIP messages will create/update publications on the Publications tab</li>
            <li>CIS messages will create/update subscriptions on the Subscriptions tab</li>
          <p class="warn">But messages will not be automatically subject to GDSN data pool validation, workflow, or routing</p>
         <p>Note: Later and upon request, workflow execution will generate a GS1Response message (transaction success or message exception), persisted as a new message with a referring request_msg_id to this one.</p>
         <p>Any other new messages required will also be generated and persisted during workflow. These include: gr-BPR, gr-RCI, gr-CIS, gr-RFCIN, tp-CIN, tp-CIC, odp-CIC, odp-CIN, and odp-HWM.</p>
         <p>These downstream workflow messages can then later be validated and routed in order to advance the GDSN process</p>

        </div>
        <div>
          <h4>Text Upload</h4>
          <br/><textarea rows="6" cols="100" ng-model="msg_content_post"></textarea>
          <br/><button ng-click="post_msg('msg_url')">Post</button>
        </div>
      </div>

      <div>View Message</div>
      <div>
        Message ID:
        <br/><input type="text" ng-model="view_msg_id"/>
        <br/><button ng-click="view_msg()">View</button>
        <br/><textarea rows="6" cols="100" id="msg_content_view"></textarea>
        <br/><span ng-if="view_msg_id">[<a ng-href="/cs_api/1.0/msg/{{view_msg_id}}">Link to message {{view_msg_id}}</a>]</span>
      </div>

      <div>GDSN Auto Message</div>
      <div>
        <div ng-controller="gdsn_file_controller">
          <form>
              <input type="file" multiple="true" ng-file-select="onFileSelect($files, 'gdsn_auto')"></input>
              <button ng-click="uploadFile('gdsn_auto')">Upload File</button>
          </form>
        </div>
        <div>
          <br/><textarea rows="6" cols="100" ng-model="msg_content_post"></textarea>
          <br/><button ng-click="post_msg('gdsn_auto')">Post</button>
        </div>
      </div>

<!--
      <div>Post Message to GDSN Data Pool</div>
      <div>
        <div ng-controller="gdsn_file_controller">
          <input type="file" multiple="true" ng-file-select="onFileSelect($files, 'gdsn_send')"></input>
          <button ng-click="uploadFile('gdsn_send')">Upload File to GDSN</button>
        </div>
        <div>
          <br/><textarea rows="6" cols="100" ng-model="msg_content_post"></textarea>
          <br/><button ng-click="post_msg('gdsn_send')">Post XML to GDSN</button>
        </div>
      </div>

      <div>Validate Message with GDSN Data Pool</div>
      <div>
        <div ng-controller="gdsn_file_controller">
          <input type="file" multiple="true" ng-file-select="onFileSelect($files, 'gdsn_validate')"></input>
          <button ng-click="uploadFile('gdsn_validate')">Validate XML File</button>
        </div>
        <div>
          <br/><textarea rows="6" cols="100" ng-model="msg_content_post"></textarea>
          <br/><button ng-click="post_msg('gdsn_validate')">Validate XML Text</button>
        </div>
      </div>

      <div>JSON Data</div>
      <div>
        <button ng-click="list_msg()">Update</button>
        <pre id="message_list"></pre>
      </div>

-->
    </div> <!-- end msg accordion -->
  </div> <!-- end msg_tab -->



  <div id="party_tab" ng-controller="gdsn_party_controller">
    <div id="party_accordion">

      <div>Search Trading Parties</div>
      <div>
        <br/>
        <button ng-if="!parties" ng-click="list_parties()">Load Parties</button>
        <button ng-if="page > 0" ng-click="list_parties(-1)">Prev</button>
        <button ng-if="parties && parties.length == 10" ng-click="list_parties(1)">Next</button>
        <div ng-if="parties" style="border-style:solid;border-width:1px;border-color:green">
          <table>
            <tr>
              <th>Name</th>
              <th>GLN</th>
              <th>Country</th>
              <th>Data Pool</th>
              <th>Created</th>
              <th>Modified</th>
            </tr>
            <tr class="clickable" ng-repeat="party in parties" ng-click="showPartyDetail(party)">
              <td>{{party.name}}</td>
              <td>{{party.gln}}</td>
              <td>{{party.tm}}</td>
              <td>{{party.source_dp}}</td>
              <td>{{party.created_ts}}</td>
              <td>{{party.modified_ts}}</td>
              <!-- Raw Data: '{{party}}' -->
            </tr>
          </table>
        </div>
      </div>

      <div>Trading Party Details</div>
      <div>
        GLN:
        <br/><input type="text" ng-model="input_party_gln"/>
        <br/><button ng-click="view_party()">View</button>
        <br/><textarea rows="6" cols="100" id="party_content_view"></textarea>
        <br/><span ng-if="input_party_gln">[<a ng-href="/cs_api/1.0/party/{{input_party_gln}}?download=true">Download link to catalog party {{input_party_gln}}</a>]</span>
      </div>

      <div>Post Trading Parties RPDD File</div>
      <div>
        <div ng-controller="gdsn_file_controller">
          <input type="file" multiple="true" ng-file-select="onFileSelect($files, 'parties_url')"></input>
          <button ng-click="uploadFile('parties_url')">Upload File</button>
        </div>
        <div>
          <br/>Or paste CIN XML:
          <br/><textarea rows="6" cols="100" ng-model="party_content_post"></textarea>
          <br/><button ng-click="post_parties()">Post XML</button>
        </div>
      </div>

    </div>
  </div> <!-- end party_tab -->



  <div id="item_tab" ng-controller="gdsn_item_controller">
    <div id="item_accordion">

      <div>Search Catalog Items</div>
      <div>
        <span>GTIN          <input type="text" ng-model="input_item_gtin" size="16" placeholder="99999999999999"></input></span>
        <span>Provider GLN  <input type="text" ng-model="input_item_provider" size="15" placeholder="1100001011292"></input></span>
        <span>Recipient GLN <input type="text" ng-model="input_item_recipient" size="15" placeholder="0625199000015"></input></span>
        <span>TM Country    <input type="text" ng-model="input_item_tm" size="3" placeholder="840"></input></span>
        <span>TM Sub        <input type="text" ng-model="input_item_tm_sub" size="5" placeholder="US-CA"></input></span>
        <span>Per page      <input ng-model="input_per_page" size="3"></input></span>
        <p/>
        <span>XML Regex     <input type="text" ng-model="input_item_xml_text" size="30" placeholder="foodAndBev"></input></span>
        <span>Msg ID Regex  <input type="text" ng-model="input_item_msg_id_text" size="30" placeholder="CIN_IN_"></input></span>
        <span>Unit Descriptor
          <select ng-model="input_item_unit_descriptor">
            <option value="CASE">Case</option>
            <option value="BASE_UNIT_OR_EACH">Each</option>
            <option value="DISPLAY_SHIPPER">Display Shipper</option>
            <option value="MIXED_MODULE">Mixed Module</option>
            <option value="MULTIPACK">Multipack</option>
            <option value="PACK_OR_INNER_PACK">Pack or Inner Pack</option>
            <option value="PALLET">Pallet</option>
            <option value="PREPACK">Prepack</option>
            <option value="PREPACK_ASSORTMENT">Prepack Assortment</option>
            <option value="SETPACK">Setpack</option>
            <option value="TRANSPORT_LOAD">Transport Load</option>
          </select>
        </span>
        <br />
        <span>Created Start Date <input type="text" size="10" ng-model="input_created_st_date"        placeholder="8/21/2014" datepicker></input></span>
        <span>Created End Date   <input type="text" size="10" ng-model="input_created_end_date"       placeholder="8/24/2014" datepicker></input></span>
        <span>Modified Start Date<input type="text" size="10" ng-model="input_modified_st_date"        placeholder="8/26/2014" datepicker></input></span>
        <span>Modified End Date  <input type="text" size="10" ng-model="input_modified_end_date"       placeholder="8/28/2014" datepicker></input></span>
        <button ng-click="list_items(0)">Search</button>
        <button ng-click="reset_search()">Reset</button>
        <p/>
        <div ng-if="items">
          <table width="100%">
            <tr>
              <th>Photo</th>
              <th>GTIN</th>
              <th>Provider</th>
              <th>TM Country</th>
              <th>TM Sub</th>
              <th>Recipient</th>
              <th>Child Count</th>
              <th>Created</th>
              <th>Modified</th>
              <th>CIN Message</th>
            </tr>
            <tr class="clickable" ng-repeat="item in items" ng-click="showItemDetail(item)">
              <td><img height="30" ng-src="{{ item.thumbnail }}"/></td>
              <td>{{item.gtin}}</td>
              <td>{{item.provider}}</td>
              <td>{{item.tm}}</td>
              <td>{{item.tm_sub}}</td>
              <td>{{item.recipient}}</td>
              <td>{{item.child_gtins && item.child_gtins.length}}</td>
              <td>{{item.created_ts}}</td>
              <td>{{item.modified_ts}}</td>
              <td>{{item.msg_id}}</td>
            </tr>
          </table>
          <p/>
          <p class="centered">
            <button ng-if="page > 1" ng-click="list_items(-page)">First</button>
            <button ng-if="page > 0" ng-click="list_items(-1)">Prev</button>
            <span>Page:<span>{{ page + 1 }}</span>
            <button ng-if="more_items" ng-click="list_items(1)">Next</button>
            <div class="centered"></span>Displaying items <span>{{ item_range_start }}</span> to {{ item_range_end }}</div>
            <div class="centered" ng-if="!(more_items)">No more items to display</div>
          </p>

          <div ng-if="selectedItem" id="selectedItem" class="blue_box">
            <div>
              <table width="100%">
                <tr>
                  <th width="40%">
                    <div ng-if="selectedItem.images && selectedItem.images.length">
                      <p><img ng-repeat="url in selectedItem.images" ng-src="{{ url }}" ng-mouseover="selectImage(url)" height="50"></img></p>
                      <p>
                        <a ng-href="{{selectedImage}}" target="_blank">
                        <img ng-src="{{selectedImage}}" width="200"></img>
                        <br/>{{selectedImage}}</a>
                      </p>
                    </div>
                  </th>
                  <th border="1">
                    <p>GTIN: {{selectedItem.gtin}}</p>
                    <p>Name: {{selectedItem.tradeItem.tradeItemInformation.tradeItemDescriptionInformation.functionalName.description[0].shortText}}</p>
                    <p>Brand: {{selectedItem.brand}}</p>
                    <p>Short Description: {{selectedItem.tradeItem.tradeItemInformation.tradeItemDescriptionInformation.descriptionShort.description[0].shortText}}</p>
                    <p>Description: {{selectedItem.tradeItem.tradeItemInformation.tradeItemDescriptionInformation.tradeItemDescription[0].text}}</p>
                    <p>Additional Description: {{selectedItem.tradeItem.tradeItemInformation.tradeItemDescriptionInformation.additionalTradeItemDescription[0].text}}</p>
                    <p>GPC Brick Code: {{selectedItem.gpc}}</p>
                    <p>Child GTINs: {{selectedItem.child_gtins.join(' ')}}</p>
                  </th>
                  <th>
                    <div ng-if="selectedItem.has_extension"><p>Some extension: <span>{{selectedItem.has_extension}}</span></p>
                        <div ng-if="selectedItem.has_food_and_bev"><p>Food extension: {{selectedItem.has_food_and_bev}}</p>
                            <div ng-if="selectedItem.has_nutrient_info"><p>Nutritient info: {{selectedItem.has_nutrient_info}}</p>
                                <div ng-if="selectedItem.preparationStates && selectedItem.preparationStates.length">
                                  <p>Preparation states: <span ng-repeat="state in selectedItem.preparationStates"> {{ state }} </span></p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <p>Unit type: {{selectedItem.unit_type}}</p>
                    <p>Source DP: {{selectedItem.source_dp}}</p>
                    <p>XML: <a ng-href="{{selectedItem.href}}?" target="_blank">View</a> <a ng-href="{{selectedItem.href}}?download=true">Download</a></p>
                    <p>JSON: <a ng-href="{{selectedItem.href}}?json=true" target="_blank">View</a> <a ng-href="{{selectedItem.href}}?json=true&download=true">Download</a></p>
                    <p>History: <a ng-href="{{selectedItem.history_href}}?json=true" target="_blank">View</a> <a ng-href="{{selectedItem.history_href}}?json=true&download=true">Download</a></p>
                    <p>Generate CIN: <a ng-href="{{selectedItem.cin_href}}?" target="_blank">View</a> <a ng-href="{{selectedItem.cin_href}}?download=true">Download</a></p>
                    <p><a class="clickable" ng-click="prettyPrintItem(selectedItem)">PrettyPrint Item</a></p>
                    <p><a class="clickable" ng-click="showItemHierarchy(selectedItem)">Hierarchy</a></p>
                  </th>
                </tr>
              </table>
            </div>

            <div width="100%" id="three_item_view"></div>

          </div> <!-- end if selectedItem -->
        </div> <!-- end if items -->

        <div ng-if="previousSearches" class="blue_box">
          <p>Search History:</p>
          <p class="clickable draggable" ng-repeat="search in previousSearches" ng-click="redoPreviousItemSearch(search)">{{search}}</p>
        </div>

      </div>

      <div>Catalog Item History</div>
      <div>
        GTIN:
        <br/><input type="text" ng-model="input_item_gtin"/>
        <br/><button ng-click="view_catalog_item()">View</button>
        <br/><textarea rows="6" cols="100" id="item_content_view"></textarea>
        <br/><span ng-if="input_item_gtin">[<a ng-href="/cs_api/1.0/items/{{input_item_gtin}}?download=true">Download link to catalog item {{input_item_gtin}}</a>]</span>
      </div>

      <div>Post Catalog Items</div>
      <div>
        <div ng-controller="gdsn_file_controller">
          Multi-item file upload: <input type="file" multiple="true" ng-file-select="onFileSelect($files, 'item_url')"></input>
          <button ng-click="uploadFile('item_url')">Upload File</button>
          <br/>
          Single item file upload: <input type="file" multiple="true" ng-file-select="onFileSelect($files, 'single_item_url')"></input>
          <button ng-click="uploadFile('single_item_url')">Upload File</button>
        </div>
        <div>
          <br/>Or paste CIN XML:
          <br/><textarea rows="6" cols="100" ng-model="item_content_post"></textarea>
          <br/><button ng-click="post_catalog_items()">Post Multi-Item XML</button>
          <button ng-click="post_catalog_item()">Post Single Item XML</button>
        </div>
      </div>

    </div>
  </div> <!-- end item_tab -->

  <div id="pub_tab" ng-controller="gdsn_pub_controller">
    <div id="pub_accordion">

      <div>Search Publications</div>
      <div id="pub_list">
        <div>
          <input type="text" ng-model="publisher"></input>
          <input type="button" ng-click="getPublications(publisher)" value="Get Publications"></input>
          <div ng-if="data.publisher">
            <div>Publications for ITN publisher {{data.publisher}} as of <span ng-bind="timestamp"/>:</div>
            <div class="clickable" ng-repeat="pub in data.publications" ng-click="showPubDetail(pub)">
              <span>{{$index + 1}}. Published to GLN: {{pub.publishToGLN}}
                <br/>Item GTIN: {{pub.gtin}}
                <br/>Item TM/TMSub: {{pub.tm}}/{{pub.tmsub}}
              </span>
            </div>
          </div>
          <div ng-if="data.url">Data URL: <a ng-href="{{data.url}}">{{data.url}}</a></div>
        </div>
      </div>

      <div>Find Unpublished Items</div>
      <div id="find_not_pub">Loading...</div>

      <div>Publish Item to Subscriber GLN</div>
      <div id="pub_util">
        <form id="pub_form">
            <p>* Publisher GLN:<br/><input type="text" name="ds" ng-model="publisher"/></p>
            <p>* Product GTIN:<br/><input type='text' name='gtin'/></p>
            <p>* Product TM numeric ISO code (e.g. '840'):<br/><input type='text' name='tm'/></p>
            <p>  Product TM subdivision alpha code (e.g. 'US-CA'):<br/><input type='text' name='tms'/></p>
            <p>* Publish-To GLN:<br/><input type='text' name='dr'ng-model="subscriber"/></p>
            <p>Initial load<br/><input type='checkbox' name='il'/></p>
            <button ng-click="publish_item()">Submit</button>
            <div id="pub_result">Loading...</div>
        </form>
      </div>

    </div>
  </div> <!-- end pub_tab -->

  <div id="sub_tab">
    <div id="sub_accordion">
      <div>Fetch Subscribed Items</div>
      <div ng-controller="gdsn_sub_controller">

        <div>
          <form id="sub_form">
            <table>
              <tr>
                <td>
                  <p>* GTIN<br/><input id="input_gtin" value="00038000105234" size="40"></input></p>
                  <p>Provider GLN<br/><input id="input_provider" value="" size="40"></input></p>
                </td>
                <td>
                  <p>Target Market Country Code<br/><input id="input_tm" value="" size="40"></input></p>
                  <p>Target Market Subdivision Code<br/><input id="input_tm_sub" value="" size="40"></input></p>
                </td>
              </tr>
              <tr>
                <td>
                  <p><input id="input_include_children" type="checkbox"></input>  Include Children</p>
                  <p><input id="input_include_parents" type="checkbox"></input>   Include Parents</p>
                  <p><input id="input_food_only" type="checkbox"></input>         Only items with Food/Bev Info </p>
                </td>
                <td>
                  <p>Data Transform <select name="trans_type" id="input_server_transform"><option value="">None</option><option value="client">Client</option><option value="server">Server</option></select></p>
                  <p><input id="input_multi_gtin" type="checkbox"></input>        Multi: allow multiple items with same GTIN</p>
                </td>
              </tr>
              <tr>
                <td>
                  <p><button id="btn_fetch" ng-click="getSubscribedItems()">Fetch Items</button></p>
                </td>
                <td>
                  <p><button id="btn_fetch_hide" ng-click="resetSubscribedItems()">Clear Results</button></p>
                </td>
              </tr>
            </table>
          </form>
        </div>

        <p id="sub_error" ng-if="sub_error">{{ sub_error }}</p>
        <div id="sub_result" ng-if="subscribed_items">
          <p id="sub_msg" ng-if="sub_msg">{{ sub_msg }}</p>
          <div ng-repeat="item in subscribed_items">
            <span>Item {{ item.href }} ({{ item.fetch_type }}):</span>
            <br/><textarea rows="6" cols="120">{{ item }}</textarea>
          </div>
        </div>

      </div><!-- end sub controller -->

      <div>Search Subscriptions</div>
      <div>
        <div gdsn-subscriptions default-subscriber="1100001011292"/>
      </div>

    </div> <!-- end sub_accordion -->
  </div> <!-- end sub_tab -->

</div><!-- end tabs -->



<div id="debug_tab" ng-controller='gdsn_debug_controller'>
  <div id="debug_accordion">
  
    <div>Search Logging</div>
    <div>
        <p/>
        <span>Start Date     <input type="text" size="14" ng-model="input_startdate" placeholder="8/21/2014" datepicker></input></span> 
        <span>End Date     <input type="text" size="10" ng-model="input_enddate" placeholder="8/29/2014" datepicker></input></span>
        <span>Log Level
          <select ng-model="input_log_level">
            <option value="debug">debug</option>
            <option value="info">info</option>
            <option value="warn">warn</option>
            <option value="error">error</option>
          </select>
        </span>
        <span>Message Regex     <input type="text" ng-model="input_log_regex" size="30" placeholder="req_id"></input></span>
        <span>Username     <input type="text" size="15" ng-model="input_username" placeholder="per" ></input></span>
        <span>Min Duration (ms)     <input type="text" size="8" ng-model="input_duration" placeholder="200" ></input></span>
        <br />
        <span>Per Page      <input ng-model="input_per_page" placeholder="10" size="3"></input></span>
        <button ng-click="list_fileLogs(0)">Search</button>
        <button ng-click="reset_log_search()">Reset</button>

        <div ng-if="fileLogs" style="border-style:solid;border-width:1px;border-color:green">
          <table>
            <tr>
              <th>Timestamp</th>
              <th>Level</th>
              <th>Message</th>
              <th>Username</th>
              <th>Duration<br />(ms)</th>
              <th>Id</th>
            </tr>
            <tr class="clickable" ng-repeat="fileLog in fileLogs">
              <td>{{fileLog.timestamp}}</td>
              <td>{{fileLog.level}}</td>
              <td>{{fileLog.message}}</td>
              <td>{{fileLog.username}}</td>
              <td>{{fileLog.duration}}</td>
              <td>{{fileLog._id}}</td>
            </tr>
          </table>
        </div>
        
        <p class="centered">
            <button ng-if="page > 1" ng-click="list_fileLogs(-page)">First</button>
            <button ng-if="page > 0" ng-click="list_fileLogs(-1)">Prev</button>
            <span>Page:<span>{{ page + 1 }}</span>
            <button ng-if="more_items" ng-click="list_fileLogs(1)">Next</button>
            <div class="centered"></span>Displaying items <span>{{ item_range_start }}</span> to {{ item_range_end }}</div>
            <div class="centered" ng-if="!(more_items)">No more items to display</div>
      </p>
  </div>

    <div>Already existing...</div>
    <div>
    <div>Model values:</div>
    <div>Subscriber: {{subscriber}}</div>
    <div>Publisher: {{publisher}}</div>
    <div>View Message ID: {{view_msg_id}}</div>
    <div>Message post content: <textarea disabled>{{msg_content_post}}</textarea></div>
    <div id="snoop">Loading...</div>
  </div>
  
  </div>   <!-- end debug_accordion -->
</div>  <!-- end debug_tab -->

<div id="footer_area">
  <p>Copyright &copy; 2015</p>
</div>

<div id="result_dialog" width="100%">Loading...</div>

<div id="error_dialog">An error occurred!</div>

<div id="progress_dialog">
  <p class="vert_spacer" ></p>
  <div id="progressbar"></div>
</div>

<script src="js/jp-pretty-print-101.js"></script>
<script src="js/jquery-1.10.2.js"></script>
<script src="jqui/jquery-ui-1.10.4.custom.js"></script>
<script src="js/underscore-1.5.2.js"></script>

<!-- script src="js/angular-1.2.2.js"></script-->
<!-- script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.3.15/angular.js"></script-->
<script src="js/angular-1.3.15.js"></script>

<script src="js/file/angular-file-upload.js"></script>

<script src="js/bp_cs_client.js"></script>

<script src="js/cs_page_utils.js"></script>

<script>
  var gdsn_app = angular.module('gdsn_app', ['angularFileUpload'])
</script>
<script src="js/ang_app_module.js"></script>
<script src="js/ang_controller_file.js"></script>
<script src="js/ang_controller_msg.js"></script>
<script src="js/ang_controller_party.js"></script>
<script src="js/ang_controller_item.js"></script>
<script src="js/ang_controller_pub.js"></script>
<script src="js/ang_controller_sub.js"></script>
<script src="js/ang_controller_debug.js"></script>
<script src="js/ang_directives.js"></script>
<script src="js/ang_directive_gdsn-sub/directive.js"></script>

<script>
  gdsn_app.factory('gdsn', ['$http', 'config', function ($http, config) { // service factory

    console.log('gdsn service factory init for home DP (SDP&RDP): ' + config.homeDataPoolGln)
    var gdsn = this

    gdsn.workflow_attempt_count = 0
    gdsn.workflow_success_count = 0
    gdsn.workflow_error_count   = 0

    gdsn.archive_success_count = 0
    gdsn.archive_error_count   = 0

    gdsn.migrate_success_count = 0
    gdsn.migrate_error_count   = 0

    // gdsn SERVICE API methods for sdo (service def obj) init when called by framework per ng-app
    gdsn.reparse_message = function (msg) {
      console.log('GDSN Server URL endpoint from config.js -- config.msg_migrate_url: ' + config.msg_migrate_url) //e.g. /cs_api/1.0/gdsn-send/:msg_id/:sender
      var url    = config.msg_migrate_url  + '/' + msg.msg_id + '/' + msg.sender
      var params = {ts: new Date}
      return gdsn.http_get(url, params)
    }

    gdsn.send_message = function (msg) {
      console.log('GDSN Server URL endpoint from config.js -- config.gdsn_send: ' + config.gdsn_send) //e.g. /cs_api/1.0/gdsn-send/:msg_id/:sender
      var url    = config.gdsn_send + '/' + msg.msg_id + '/' + msg.sender
      var params = {ts: new Date}
      return gdsn.http_get(url, params)
    }

    gdsn.validate_message = function (msg) {
      console.log('GDSN Server URL endpoint from config.js -- config.gdsn_validate: ' + config.gdsn_validate) //e.g. /cs_api/1.0/gdsn-validate/:msg_id/:sender
      var url    = config.gdsn_validate + '/' + msg.msg_id + '/' + msg.sender
      var params = {ts: new Date}
      return gdsn.http_get(url, params)
    }

    gdsn.archive_message = function (msg) {
      console.log('GDSN Server URL endpoint from config.js -- config.msg_archive_url: ' + config.msg_archive_url) //e.g. /cs_api/1.0/msg/archive/:msg_id/:sender
      var url    = config.msg_archive_url + '/' + msg.msg_id + '/' + msg.sender
      var params = {ts: new Date}
      return gdsn.http_get (url, params)
    }
    gdsn.execute_workflow = function (msg, state) {

      console.log('gdsn.execute_workflow called for msg_id ' + msg.msg_id + ', sender: ' + msg.sender)
      console.log('workflow config GR gln: ' + config.gdsn_gr_gln)

      if (!state) state = msg.status
      this.workflow_attempt_count++
      console.log('service workflow attempt count: ' + this.workflow_attempt_count)
      var result = {req_id: this.workflow_attempt_count}

      if (msg.msg_type == 'catalogueItemConfirmation' && ['RECEIVED','REVIEW','REJECTED','SYNCHRONISED','MULTI'].indexOf(state) == -1) {
        result.success = false
        result.msg = 'unrecognized CIC state: ' + state
        result.data = {}
        console.log(result.msg)
        return result
      }
      if (!msg.gdsn_repostable) {
        result.success = false
        result.msg = 'only gdsn_repostable messages to receiver ' + config.homeDataPoolGln + ' can be workflowed, bad msg receiver: ' + msg.receiver
        result.data = {}
        console.log(result.msg)
        return result
      }

      console.log('GDSN Server URL endpoint from config.js-config.gdsn_workflow: ' + config.gdsn_workflow) //e.g. /cs_api/1.0/gdsn-workflow'
      var url = config.gdsn_workflow + '/' + msg.msg_id + '/' + msg.sender // += /:msg_id/:sender
      var ts = Date.now() // <p>{{ ts | iso }}</p>
      return gdsn.http_get(url, {params: {ts: new Date, state: state}})
    } // end gdsn.execute_workflow

    gdsn.http_get = function (url, params) {
      var ts = Date.now() // <p>{{ ts | iso }}</p>
      console.log('calling GDSN Server url: ' + url + ', at time: ' + ts)

      var gdsn = this
      var result = {req_id: gdsn.workflow_attempt_count}

      var promise1 = $http.get(url, {params: params})
      var promise2 = promise1.then(
        function (res) { // success
          console.log('-----------------------------------> http msg archive success res status: ' + res.status)
          console.log('res data: ' + res.data)
          console.dir(res)
          result.success = true
          gdsn.archive_success_count++
          result.msg = 'received SUCCESS service msg archive response for req: ' + result.req_id
          result.data = res.data
        },
        function (res) { // error 
          console.log('-----------------------------------> http msg archive error res status: ' + res.status)
          console.log('res data: ' + res.data)
          console.dir(res)
          result.success = false
          gdsn.archive_error_count++
          result.msg = 'received ERROR service msg archive response for req: ' + result.req_id
          result.data = res.data
        }
      )
      return promise2
    }


    // gS1Response to msg.sender
    gdsn.generate_accepted = function (msg) {
    }
    return gdsn
  }]) // end gdsn service factory

  gdsn_app.directive('gdsnWorkflow', function () { // gdsn_workflow gdsn-workflow
    return { // ddo when called 
      //templateUrl: welcome.html // html file url // TODO
      template    : '<div title="gdsn_workflow">'
                  + ' <div><ng-transclude/></div>'
                  + ' <button ng-click="wf.process(msg)">{{msg.status}}</button>'
                  + ' <div ng-show="msg.msg_type == \'catalogueItemNotification\' && msg.sender != msg.provider">'
                  + '  <label>CIC state:</label>'
                  + '  <input type="text" size="5" ng-model="wf.state"></input>'
                  + ' </div>'
                  + ' <div ng-show="wf.result" class="clickable selected" title="workflow success: {{wf.result}}"'
                  + '  ng-click="showMessageDetail(wf.result)">'
                  + '    Done! TS: {{wf.result.status}}'
                  + ' </div>'
                  + '</div>'
      ,restrict   : 'E'
      ,replace    : true
      ,transclude : true
      ,controller : 'gdsn_workflow_directive_controller'
      ,controllerAs: 'wf'
      ,link       : function ($scope, $el, attrs, ctrl) { 
        console.log('directive scope index: ' + $scope.$parent.$index)
        console.log('directive controller count: ' + ctrl.count)
        console.log('directive element: ' + $el.text())
        // api doc debug:
        //console.log('directive link function arguments: ')
        //console.dir(arguments)
      }
    }
  }) // end gdsnWorkflow gdsn_workflow <gdsn-workflow/> directive

  gdsn_app.controller('gdsn_workflow_directive_controller', ['gdsn','config',function (gdsn, config) {
    var wf = this
    console.log('init wf dir ctrl')

    wf.note = 'this is a controller instance for a single directive occurrence'
    wf.dir_ctrl_attempt_count = 0
    wf.result   = ''
    wf.state    = ''
    wf.ts       = Date.now()

    wf.process = function (msg) { 
      wf.dir_ctrl_attempt_count++
      console.log('wf dir ctrl - process attempts: ' + wf.dir_ctrl_attempt_count)
      console.log('wf dir ctrl - process: ' + msg.msg_id)
      gdsn.execute_workflow(msg, wf.state || msg.status) 
    }
  }])

  gdsn_app.controller('gdsn_msg_set_controller', ['gdsn','config', function (gdsn, config) { // aka 'rs_ctrl'
      var resultset_ctrl = this
      resultset_ctrl.set_count = 0
      resultset_ctrl.selectAll = false
      resultset_ctrl.sets = []
      resultset_ctrl.newSetName = ''

      resultset_ctrl.createSet = function (messages) {
        var selected = resultset_ctrl.getSelected(messages)
        var new_set = {
          name: resultset_ctrl.newSetName || 'set id ' + (++resultset_ctrl.set_count)
          ,messages: selected
          ,count   : selected.length
          ,ts      : new Date
        }
        resultset_ctrl.sets.push(new_set)
        resultset_ctrl.newSetName = '' // clear input field
        resultset_ctrl.selectAll = false
        resultset_ctrl.updateSelectAll(messages)

        console.log('gdsn_msg_set_controller.createSet succeeded for new set: ' + new_set)
        console.log('total number of saved sets: ' + resultset_ctrl.sets.length)
      }
      resultset_ctrl.removeSet = function (set) {
        var idx = resultset_ctrl.sets.indexOf(set)
        console.log('TODO: remove set with idx ' + idx)
        if (idx > -1) resultset_ctrl.sets.splice(idx, 1)
      }
      resultset_ctrl.getSelected = function (messages) {
        var sel = messages && messages.filter(function (msg) {
          return msg.selected
        })
        return sel ? sel : []
      }
      resultset_ctrl.recallSelected = function (messages, selected_set) {
        var sel = messages && messages.filter(function (msg) {
          msg.selected = selected_set.indexOf(msg) > -1
          return msg.selected
        })
        return sel ? sel : []
      }
      resultset_ctrl.updateSelectAll = function (messages) { // select or un-select all
        messages && messages.forEach(function (msg) {
          msg.selected = resultset_ctrl.selectAll
        })
      }
      resultset_ctrl.toggleSelected = function (messages) {
        messages && messages.forEach(function (msg) {
          msg.selected = !msg.selected
        })
      }
      resultset_ctrl.sendSelected = function (messages) {
        var sent = []
        messages && messages.forEach(function (msg) {
          if (msg.selected) {
            gdsn.send_message(msg)
            sent.push(msg)
          }
        })
        sent.forEach(function(msg) {
          console.log('sent msg with msg_id ' + msg.msg_id)
          // TODO highlight sent item, update history?
        })
      }
      resultset_ctrl.validateSelected = function (messages) {
        var validated = []
        messages && messages.forEach(function (msg) {
          if (msg.selected) {
            gdsn.validate_message(msg)
            validated.push(msg)
          }
        })
        validated.forEach(function(msg) {
          console.log('validated msg with msg_id ' + msg.msg_id)
          // TODO highlight validated item, update history?
        })
      }
      resultset_ctrl.archiveSelected = function (messages) {
        var archived = [] // for immediate removal
        messages && messages.forEach(function (msg) {
          if (msg.selected) {
            gdsn.archive_message(msg)
            archived.push(msg)
          }
        })
        archived.forEach(function(msg) {
          var idx = messages.indexOf(msg);
          if (idx > -1) messages.splice(idx, 1)
        })
      }
      resultset_ctrl.reparseSelected = function (messages) {
        messages && messages.forEach(function (msg) {
          if (msg.selected) {
            gdsn.reparse_message(msg)
          }
        })
      }
      resultset_ctrl.workflowSelected = function (messages) {
        messages && messages.forEach(function (msg) {
          if (msg.selected) {
            gdsn.execute_workflow(msg, '')
          }
        })
      }
  }])
</script>
<script src="three_view/js/three_r68.js"></script>
<script src="three_view/js/controls/OrbitControls.js"></script>
<script src="three_view/js/three_item_view.js"></script>

</body>
</html>
