<!DOCTYPE html>
<html lang="us">
<head>
  <!-- Version $URL: $ -->
  <meta charset="utf-8">
  <title>Catalog Services Dashboard</title>
  <meta http-equiv="X-UA-Compatible" content="IE=EDGE" />
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
  <!--<link rel="stylesheet" type="text/css" href="css/styles.css" />-->
  <link rel="stylesheet" type="text/css" href="css/styles_new.css" />
  <link rel="stylesheet" type="text/css" href="jqui/jquery-ui-1.10.4.custom.css" />

  <style type="text/css">
    .clickable { 
      cursor: pointer; 
      border: #ccc dotted 1px; 
    }
    .selected {
      border: #ccf dashed 1px; 
    }
  </style>

  <style type="text/css">
    #progressbar .ui-progressbar-value {
      background-color:#ccf;
    }
    div.blue_box {
      border-style: solid;
      border-width: 1px;
      border-color: blue;
      font-family: sans-serif;
      color: blue;
    }
  </style>

  <script type="text/javascript" src="js/jquery-1.10.2.js"></script>
  <script type="text/javascript" src="jqui/jquery-ui-1.10.4.custom.js"></script>
  <script type="text/javascript" src="js/underscore-1.5.2.js"></script>
  <script type="text/javascript" src="js/angular-1.2.2.js"></script>
  <script type="text/javascript" src="js/file/angular-file-upload.js"></script>
  
</head>
<body ng-app="thx_app">

<script type="text/ng-template" id="gdsn_template.html">
  <div style="border-style:solid;border-width:1px;border-color:blue">
    <div>GDSN Widget</div>
    <div ng-if="data" style="border-style:solid;border-width:1px;border-color:green">
      <div ng-if="selectedItem"><textarea rows="6" cols="60" disabled ng-bind="selectedItem"></textarea></div>
      <div>Subscriptions for subscriber {{data.subscriber}} as of <span ng-bind="timestamp"/>:</div>
      <div class="clickable" ng-repeat="sub in data.subscriptions" ng-click="showDetail(sub)">
        <span>{{$index + 1}}. Publisher/Data Source: {{sub.dsName}} (GLN {{sub.ds}})</span>
      </div>
      <div>Data URL: <a ng-href="{{data.url}}">{{data.url}}</a></div>
      <div>Timestamp: <span>{{timestamp}}</span></div>
    </div>
    <div>thx_controller_test: <span>{{thx_controller_test}}</span></div>
    <div>dir_controller_test: <span>{{dir_controller_test}}</span></div>
    <div>dir_link_test: <span>{{dir_link_test}}</span></div>
  </div>
</script>



<div id="tabs" ng-controller="thx_controller">

<div>
  <h2>Catalog Services Dashboard</h2>
  <!-- Version $URL: $ -->
</div>

  <ul>
    <li><a href="#main_menu">Main Menu</a></li>
    <li><a href="#ci_tab">Catalog Items</a></li>
    <li><a href="#msg_tab">Messages</a></li>
    <li><a href="#pub_tab">Publication</a></li>
    <li><a href="#sub_tab">Subscription</a></li>
  </ul>

  <div id="main_menu">
    <div class="blue_box">
      <div id="welcome">[Loading welcome.html]</div>
    </div>
  </div>

  <div id="ci_tab">
    <div id="ci_accordion">
      <div>List Catalog Items</div>
      <div>
        <br/><button ng-click="list_catalog_items()">Update</button>
        <pre id="ci_list"></pre>
      </div>
      <div>Catalog Item Details</div>
      <div>
        GTIN:
        <br/><input type="text" ng-model="ci_gtin"/>
        <br/><button ng-click="view_catalog_item()">View</button>
        <br/><textarea rows="6" cols="100" id="ci_content_view"></textarea>
        <br/><span ng-if="ci_gtin">[<a ng-href="/api/1.0/items/{{ci_gtin}}">Link to catalog item {{ci_gtin}}</a>]</span>
      </div>
      <div>Post Catalog Items</div>
      <div>
        <div ng-controller="thx_file_controller">
          <input type="file" ng-file-select="onFileSelect($files)"></input>
          <button ng-click="uploadFile()">Upload File</button>
        </div>
        <br/>Or paste CIN XML:
        <br/><textarea rows="6" cols="100" ng-model="ci_content_post"></textarea>
        <br/><button ng-click="post_catalog_items()">Post XML</button>
        
      </div>
    </div>
  </div>

  <div id="msg_tab">
    <div id="msg_accordion">
      <div>View Message</div>
      <div>
        Message ID:
        <br/><input type="text" ng-model="view_msg_id"/>
        <br/><button ng-click="view_archive_message()">View</button>
        <br/><textarea rows="6" cols="100" id="msg_content_view"></textarea>
        <br/><span ng-if="view_msg_id">[<a ng-href="/api/1.0/archive/{{view_msg_id}}">Link to message {{view_msg_id}}</a>]</span>
      </div>
      <div>Post Message</div>
      <div>
        <br/><textarea rows="6" cols="100" ng-model="msg_content_post"></textarea>
        <br/><button ng-click="post_to_archive()">Post</button>
      </div>
      <div>List All Messages</div>
      <div>
        <br/><button ng-click="update_msg_list()">Update</button>
        <pre id="message_list"></pre>
      </div>
    </div>
  </div>

  <div id="pub_tab">
    <div id="pub_accordion">
      <div>Publication List</div>
      <div id="pub_list">
        <div>
          <input type="text" ng-model="publisher"></input>
          <input type="button" ng-click="getPublications(publisher)" value="Get Publications"></input>
          <div ng-if="data.publisher">
            <div ng-if="selectedItem" class="blue_box">
              <span>Link: {{selectedItem.xml_link}}</span>
              <a ng-href="{{selectedItem.xml_link}}">Download Trade Item XML</a>
            </div>
            <div>Publications for ITN publisher {{data.publisher}} as of <span ng-bind="timestamp"/>:</div>
            <div class="clickable" ng-repeat="pub in data.publications" ng-click="showDetail(pub)">
              <span>{{$index + 1}}. Published to GLN: {{pub.publishToGLN}}
                <br/>Item GTIN: {{pub.gtin}}
                <br/>Item TM/TMSub: {{pub.tm}}/{{pub.tmsub}}
              </span>
            </div>
          </div>
          <div ng-if="data.url">Data URL: <a ng-href="{{data.url}}">{{data.url}}</a></div>
        </div>
      </div>
      <div>Find Unpublished Items</div>
      <div id="find_not_pub">Loading...</div>
      <div>Publish Item to Subscriber GLN</div>
      <div id="pub_util">
        <form id="form_publish">
            <p>* Publisher GLN:<br/><input type="text" name="ds" ng-model="publisher"/></p>
            <p>* Product GTIN:<br/><input type='text' name='gtin'/></p>
            <p>* Product TM numeric ISO code (e.g. '840'):<br/><input type='text' name='tm'/></p>
            <p>  Product TM subdivision alpha code (e.g. 'US-CA'):<br/><input type='text' name='tms'/></p>
            <p>* Publish-To GLN:<br/><input type='text' name='dr'ng-model="subscriber"/></p>
            <p>Initial load<br/><input type='checkbox' name='il'/></p>
            <input id="btn_api_publish" type="button" value="API Publish"></input>
            <div id="api_result">Loading...</div>
        </form>
      </div>
    </div>
  </div>

  <div id="sub_tab">
    <div id="sub_accordion">
      <div>Subscription List</div>
      <div>
        <input type="text" ng-model="subscriber"></input>
        <input type="button" ng-click="getSubscriptions(subscriber)" value="Get Subscriptions"></input>
        <div gdsn-subscriptions default-subscriber="1100001011292"/>
      </div>
    </div>
  </div>

</div><!-- end tabs -->

<div id="debug_tab">
  <div>Model values:</div>
  <div>Subscriber: {{subscriber}}</div>
  <div>Publisher: {{publisher}}</div>
  <div>View Message ID: {{view_msg_id}}</div>
  <div>Message post content: <textarea disabled>{{msg_content_post}}</textarea></div>
  <div id="snoop">Loading...</div>
</div>

<div id="footer_area">
  <p>Copyright &copy; 2014</p>
</div>

<div id="progress_dialog">
    <p class="vert_spacer" ></p>
    <div id="progressbar"></div>
</div>

<script>
  (function() {

    var app = {
      version: "1.0"
      , ts: Date.now()
      , debug: true
      , api: '/api/1.0'
    }

    var thx_app = angular.module('thx_app', ['angularFileUpload'])

    thx_app.factory('thx_util', function () {
      var getItemUrl = function (item) {
        var url = app.api + '/tradeItem?download=true'
        url += '&gln='   + item.gln
        url += '&gtin='  + item.gtin
        url += '&tm='    + item.tm
        if (item.tmsub) url += '&tmsub=' + item.tmsub
        return url
      }
      return {
          sub_url     : app.api + '/subscriptionList'
        , pub_url     : app.api + '/publicationList'
        , archive_url : app.api + '/archive'
        , item_url    : app.api + '/items'
        , getItemUrl  : getItemUrl
      }
    })

    thx_app.controller('thx_file_controller', function($scope, $upload) {
      $scope.onFileSelect = function($files) {
        $scope.selectedFile = $files && $files[0]
      }
      $scope.uploadFile = function() {
          var file = $scope.selectedFile
          $scope.upload = $upload.upload({
            url: 'api/1.0/items',
            // method: POST or PUT,
            // headers: {'headerKey': 'headerValue'},
            // withCredentials: true,
            data: {myObj: $scope.myModelObj},
            file: file,
          }).progress(function(evt) {
            console.log('percent: ' + parseInt(100.0 * evt.loaded / evt.total));
          }).success(function(data, status, headers, config) {
            // file is uploaded successfully
            console.log(data);
            alert('File uploaded successfully (' + data + ')')
          });
          //.error(...)
          //.then(success, error, progress); 
      }
    })

    thx_app.controller('thx_controller', function($scope, $http, thx_util) {
      $scope.timestamp = 'n/a'
      $scope.thx_controller_test = 'thx_controller_test_value'

      $scope.showDetail = function (item) {
        console.log('showDetail')
        console.log(item)

        item.xml_link = thx_util.getItemUrl(item)
        $(item).addClass('selected')
        $scope.selectedItem = JSON.stringify(item)
        //$scope.selectedItem = item
      }

      $scope.getSubscriptions = function (subGln) {
        if (/\d{13}/.test($scope.subscriber)) {
          //$http.jsonp(thx_util.sub_url + '?callback=JSON_CALLBACK' , {
          $http.get(thx_util.sub_url, { 
            params: { subscriber: $scope.subscriber }
          })
          .success(function (data) {
            $scope.data = data
            $scope.timestamp = data.timestamp
            $scope.selectedItem = null
          })
          .error(function () {
            console.log(arguments)
          })
        }
        else {
          alert('Error: invalid gln, should be 13 digits')
        }
      }

      $scope.getPublications = function (pubGln) {
        $http.get(thx_util.pub_url, { 
          params: { publisher: pubGln }
        })
        .success(function (data) {
          $scope.data = data
          $scope.timestamp = data.timestamp
          $scope.selectedItem = null
        })
        .error(function () {
          console.log(arguments)
        })
      }

      $scope.post_to_archive = function () {
        $http.post(thx_util.archive_url, $scope.msg_content_post + '\n\n')
        .success(function (data) {
          console.log(data)
        })
        .error(function () {
          console.log(arguments)
        })
      }

      $scope.post_catalog_items = function () {
        $http.post(thx_util.item_url, $scope.ci_content_post + '\n\n')
        .success(function (data) {
          console.log(data)
          alert('XML uploaded successfully (' + data + ')')
        })
        .error(function () {
          console.log(arguments)
        })
      }

      $scope.list_catalog_items = function () {
        $('#ci_list').load(app.api + '/items')
      }

      $scope.update_msg_list = function () {
        $('#message_list').load(app.api + '/archive')
      }

      $scope.view_catalog_item = function () {
        $('#ci_content_view').load(app.api + '/items/' + $scope.ci_gtin)
      }

      $scope.view_archive_message = function () {
        $('#msg_content_view').load(app.api + '/archive/' + $scope.view_msg_id)
      }

    })

    thx_app.directive('gdsnSubscriptions', function (thx_util) {
      console.log('directive gdsnSubscriptions')
      return {
        restrict: 'EA'
        , replace: true
        , templateUrl: 'gdsn_template.html'
        //, scope: { test_ts: '=timestamp' }
        //, scope: false // default; uses enclosing controller scope
        , scope: true // can read enclosing controller scope, not only set local dir scope (can still set scope.$parent)
        , link: function (scope, element, attrs) {
            console.log('link')
            console.log('link attrs')
            console.log(attrs)

            //scope.$parent.subscriber = element.attr('default-subscriber')

            scope.$parent.subscriber = attrs.defaultSubscriber
            console.log('scope.subscriber ' + scope.subscriber)
            scope.dir_link_test = 'dir_link_test_value'

            console.log('scope')
            console.log(scope)
          }
        , controller: function ($scope) {
            $scope.dir_controller_test = 'dir_controller_test_value'
          }
      }
    })

    $('#welcome').load('welcome.html')
    $('#find_not_pub').load('find_not_published.html')

    $('#pub_accordion').accordion({
        heightStyle: 'content',
        collapsible: true
    })

    $('#sub_accordion').accordion({
        heightStyle: 'content',
        collapsible: true
    })

    $('#ci_accordion').accordion({
        heightStyle: 'content',
        collapsible: true
    })

    $('#msg_accordion').accordion({
        heightStyle: 'content',
        collapsible: true
    })

    if (app.debug) {
      $('#debug_tab').append('<div>Timestamp: ' + app.ts + '</div>')
      $('#tabs ul').append('<li><a href="#debug_tab">Debug</a></li>')
      $('#snoop').load('snoop')
    }

    $('#tabs').tabs() //{ collapsible: true, active: false })

    $('#progress_dialog').dialog({
      autoOpen: false
      , width: 500
      , modal: true
      //, buttons: { Cancel: function() { $( this ).dialog('close') } }
    })
    
    $('#progressbar').progressbar({ value: false })

    var $result = $('#api_result').hide()
    $('#btn_api_publish').on('click', function () {
      var data = $('#form_publish').serialize()
      console.log('publishing item with data: ' + data)
      $.ajax({
          dataType: 'json',
          url: app.api + '/publish?' + data
      })
      .done(function (msg, status) {
        alert('API Publish operation complete: ' + status)
        console.log('API Publish operation complete: ' + status)
        $result.append('<div>Result: ' + status + '</div>')
        $result.show().on('click', function () {
          $(this).hide()
        })
      })
      .fail(function () {
          console.log('ajax fail: ' + arguments)
      })

    })
  })()
</script>
</body>
</html>
