<!DOCTYPE html>
<html lang="us">
<head>
  <!-- Version $URL: $ -->
  <meta charset="utf-8">
  <title>Catalog Services Dashboard</title>
  <meta http-equiv="X-UA-Compatible" content="IE=EDGE" />
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
  <!--<link rel="stylesheet" type="text/css" href="css/styles.css" />-->
  <link rel="stylesheet" type="text/css" href="css/styles_new.css" />
  <link rel="stylesheet" type="text/css" href="jqui/jquery-ui-1.10.4.custom.css" />

  <style type="text/css">
    .clickable { 
      cursor: pointer; 
      border: #ccc dotted 1px; 
    }
    .selected {
      border: #ccf solid 1px; 
    }
  </style>

  <style type="text/css">
    #progressbar .ui-progressbar-value {
      background-color:#ccf;
    }
    div.blue_box {
      border-style: solid;
      border-width: 1px;
      border-color: blue;
      font-family: sans-serif;
      color: blue;
    }
  </style>

  <script type="text/javascript" src="js/jquery-1.10.2.js"></script>
  <script type="text/javascript" src="jqui/jquery-ui-1.10.4.custom.js"></script>
  <script type="text/javascript" src="js/underscore-1.5.2.js"></script>
  <script type="text/javascript" src="js/angular-1.2.2.js"></script>
  <script type="text/javascript" src="js/file/angular-file-upload.js"></script>
  
</head>
<body ng-app="thx_app">

<script type="text/ng-template" id="gdsn_sub_list_template.html">
  <div style="border-style:solid;border-width:1px;border-color:blue">
    <div>GDSN Widget</div>
    <div ng-if="data" style="border-style:solid;border-width:1px;border-color:green">
      <div ng-if="selectedSub"><textarea rows="6" cols="60" disabled ng-bind="selectedSub"></textarea></div>
      <div>Subscriptions for subscriber {{data.subscriber}} as of <span ng-bind="timestamp"/>:</div>
      <div class="clickable" ng-repeat="sub in data.subscriptions" ng-click="selectSubscription(sub)">
        <span>{{$index + 1}}. Publisher/Data Source: {{sub.dsName}} (GLN {{sub.ds}})</span>
      </div>
      <div>Data URL: <a ng-href="{{data.url}}">{{data.url}}</a></div>
      <div>Timestamp: <span>{{timestamp}}</span></div>
    </div>
    <div>thx_controller_test: <span>{{thx_controller_test}}</span></div>
    <div>dir_controller_test: <span>{{dir_controller_test}}</span></div>
    <div>dir_link_test: <span>{{dir_link_test}}</span></div>
  </div>
</script>

<div id="tabs">

  <div>
    <h2>Catalog Services Dashboard</h2>
    <!-- Version $URL: $ -->
  </div>

  <ul>
    <li><a href="#main_menu">Main Menu</a></li>
    <li><a href="#msg_tab">Messages</a></li>
    <li><a href="#item_tab">Catalog Items</a></li>
    <li><a href="#pub_tab">Publication</a></li>
    <li><a href="#sub_tab">Subscription</a></li>
  </ul>

  <div id="main_menu">
    <div id="welcome">[Loading welcome.html]</div>
  </div>

  <div id="msg_tab" ng-controller="thx_msg_controller">
    <div id="accordion_msg">
      <div>View Message</div>
      <div>
        Message ID:
        <br/><input type="text" ng-model="view_msg_id"/>
        <br/><button ng-click="view_msg()">View</button>
        <br/><textarea rows="6" cols="100" id="msg_content_view"></textarea>
        <br/><span ng-if="view_msg_id">[<a ng-href="/api/1.0/msg/{{view_msg_id}}">Link to message {{view_msg_id}}</a>]</span>
      </div>
      <div>Post Message</div>
      <div>
        <div ng-controller="thx_file_controller">
          <input type="file" ng-file-select="onFileSelect($files, 'msg_url')"></input>
          <button ng-click="uploadFile('msg_url')">Upload File</button>
        </div>
        <div>
          <br/><textarea rows="6" cols="100" ng-model="msg_content_post"></textarea>
          <br/><button ng-click="post_msg()">Post</button>
        </div>
      </div>
      <div>List All Messages</div>
      <div>
        <br/><button ng-click="list_msg()">Update</button>
        <pre id="message_list"></pre>
      </div>
    </div>
  </div>

  <div id="item_tab" ng-controller="thx_item_controller">
    <div id="accordion_item">
      <div>List Catalog Items</div>
      <div>
        <br/><button ng-click="list_items()">Update</button>
        <div ng-if="selectedItem" class="blue_box">
          <p>Selected GTIN: {{selectedItem.gtin}}</p>
          <p><a ng-href="{{selectedItem.xml_link}}?json=true" target="_new">View JSON for catalog item {{selectedItem.gtin}}</a></p>
          <p><a ng-href="{{selectedItem.xml_link}}?json=true&download=true">Download JSON for catalog item {{selectedItem.gtin}}</a></p>
          <p><a ng-href="{{selectedItem.xml_link}}" target="_new">View XML for catalog item {{selectedItem.gtin}}</a></p>
          <p><a ng-href="{{selectedItem.xml_link}}?download=true">Download XML for catalog item {{selectedItem.gtin}}</a></p>
          <p>Child GTINs: {{selectedItem.child_gtins.join(' ')}}</p>
        </div>
        <div ng-if="items" style="border-style:solid;border-width:1px;border-color:green">
          <table>
            <tr>
              <th>GTIN</th>
              <th>Provider</th>
              <th>TM</th>
              <th>Recipient</th>
              <th>Unit Type</th>
              <th>Child Count</th>
              <th>Created</th>
              <th>Modified</th>
              <th>CIN Message ID</th>
            </tr>
            <tr class="clickable" ng-repeat="item in items" ng-click="showItemDetail(item)">
              <td>{{item.gtin}}</td>
              <td>{{item.provider}}</td>
              <td>{{item.tm}}</td>
              <td>{{item.recipient}}</td>
              <td>{{item.unit_type}}</td>
              <td>{{item.child_gtins && item.child_gtins.length}}</td>
              <td>{{item.created_ts}}</td>
              <td>{{item.modified_ts}}</td>
              <td>{{item.msg_id}}</td>
              <!-- Raw Data: '{{item}}' -->
            </tr>
          </table>
        </div>
      </div>
      <div>Catalog Item Details</div>
      <div>
        GTIN:
        <br/><input type="text" ng-model="input_item_gtin"/>
        <br/><button ng-click="view_catalog_item()">View</button>
        <br/><textarea rows="6" cols="100" id="item_content_view"></textarea>
        <br/><span ng-if="input_item_gtin">[<a ng-href="/api/1.0/items/{{input_item_gtin}}?download=true">Download link to catalog item {{input_item_gtin}}</a>]</span>
      </div>
      <div>Post Catalog Items</div>
      <div>
        <div ng-controller="thx_file_controller">
          <input type="file" ng-file-select="onFileSelect($files, 'item_url')"></input>
          <button ng-click="uploadFile('item_url')">Upload File</button>
        </div>
        <div>
          <br/>Or paste CIN XML:
          <br/><textarea rows="6" cols="100" ng-model="item_content_post"></textarea>
          <br/><button ng-click="post_catalog_items()">Post XML</button>
        </div>
      </div>
    </div>
  </div>

  <div id="pub_tab" ng-controller="thx_pub_controller">
    <div id="accordion_pub">
      <div>Publication List</div>
      <div id="pub_list">
        <div>
          <input type="text" ng-model="publisher"></input>
          <input type="button" ng-click="getPublications(publisher)" value="Get Publications"></input>
          <div ng-if="data.publisher">
            <div>Publications for ITN publisher {{data.publisher}} as of <span ng-bind="timestamp"/>:</div>
            <div class="clickable" ng-repeat="pub in data.publications" ng-click="showPubDetail(pub)">
              <span>{{$index + 1}}. Published to GLN: {{pub.publishToGLN}}
                <br/>Item GTIN: {{pub.gtin}}
                <br/>Item TM/TMSub: {{pub.tm}}/{{pub.tmsub}}
              </span>
            </div>
          </div>
          <div ng-if="data.url">Data URL: <a ng-href="{{data.url}}">{{data.url}}</a></div>
        </div>
      </div>
      <div>Find Unpublished Items</div>
      <div id="find_not_pub">Loading...</div>
      <div>Publish Item to Subscriber GLN</div>
      <div id="pub_util">
        <form id="form_publish">
            <p>* Publisher GLN:<br/><input type="text" name="ds" ng-model="publisher"/></p>
            <p>* Product GTIN:<br/><input type='text' name='gtin'/></p>
            <p>* Product TM numeric ISO code (e.g. '840'):<br/><input type='text' name='tm'/></p>
            <p>  Product TM subdivision alpha code (e.g. 'US-CA'):<br/><input type='text' name='tms'/></p>
            <p>* Publish-To GLN:<br/><input type='text' name='dr'ng-model="subscriber"/></p>
            <p>Initial load<br/><input type='checkbox' name='il'/></p>
            <button ng-click="publish_item()">Submit</button>
            <div id="api_result">Loading...</div>
        </form>
      </div>
    </div>
  </div>

  <div id="sub_tab" ng-controller="thx_sub_controller">
    <div id="accordion_sub">
      <div>Subscription List</div>
      <div>
        <input type="text" ng-model="subscriber"></input>
        <input type="button" ng-click="getSubscriptions(subscriber)" value="Get Subscriptions"></input>
        <div gdsn-subscriptions default-subscriber="1100001011292"/>
      </div>
    </div>
  </div>

</div><!-- end tabs -->

<div id="debug_tab">
  <div>Model values:</div>
  <div>Subscriber: {{subscriber}}</div>
  <div>Publisher: {{publisher}}</div>
  <div>View Message ID: {{view_msg_id}}</div>
  <div>Message post content: <textarea disabled>{{msg_content_post}}</textarea></div>
  <div id="snoop">Loading...</div>
</div>

<div id="footer_area">
  <p>Copyright &copy; 2014</p>
</div>

<div id="progress_dialog">
    <p class="vert_spacer" ></p>
    <div id="progressbar"></div>
</div>

<script>
  (function() {

    app = {
      version: "1.0"
      , ts: Date.now()
      , debug: true
      , api: '/api/1.0'
    }

    var $accordion_item = $("#accordion_item")
    $accordion_item.accordion({
        heightStyle: 'content',
        collapsible: true
    })

    var $accordion_pub = $('#accordion_pub')
    $accordion_pub.accordion({
        heightStyle: 'content',
        collapsible: true
    })

    var $accordion_sub = $('#accordion_sub')
    $accordion_sub.accordion({
        heightStyle: 'content',
        collapsible: true
    })

    var $accordion_msg = $('#accordion_msg')
    $accordion_msg.accordion({
        heightStyle: 'content',
        collapsible: true
    })

    var $progress_dialog = $('#progress_dialog')
    $progress_dialog.dialog({
      autoOpen: false
      , width: 500
      , modal: true
      //, buttons: { Cancel: function() { $( this ).dialog('close') } }
    })
    
    function showBusy(title) {
      console.log("busy 2: " + title)
      $progress_dialog.dialog("option", "title", title)
      $progress_dialog.dialog("open")
    }

    function hideBusy() {
      setTimeout(function () {
        $progress_dialog.dialog("close")
      }, 2000)
    }

    var thx_app = angular.module('thx_app', ['angularFileUpload'])

    thx_app.factory('thx_util', function () {

      var getItemUrl = function (item) {
        var url = app.api + '/items/'
        url += item.gtin + '/'
        url += item.provider + '/'
        url += item.tm + '/'
        url += item.recipient + '/'
        if (item.tm_sub) url += item.tmsub + '/'
          console.log('item url: ' + url)
        return url
      }

      return {
          sub_url     : app.api + '/subscriptionList'
        , pub_url     : app.api + '/publicationList'
        , msg_url     : app.api + '/msg'
        , item_url    : app.api + '/items'
        , getItemUrl  : getItemUrl
      }
    })

    thx_app.controller('thx_file_controller', function($scope, $upload, thx_util) {
      $scope.onFileSelect = function($files, url) {
        $scope[url + '_file'] = $files && $files[0]
      }
      $scope.uploadFile = function(url) {
          var file = $scope[url + '_file']
          if (!file) return
          $scope.upload = $upload.upload({
            url: thx_util[url], // 'api/1.0/items',
            // method: POST or PUT,
            // headers: {'headerKey': 'headerValue'},
            // withCredentials: true,
            //data: {myObj: $scope.myModelObj},
            file: file,
          }).progress(function(evt) {
            console.log('percent: ' + parseInt(100.0 * evt.loaded / evt.total));
          }).success(function(data, status, headers, config) {
            // file is uploaded successfully
            console.log(data);
            alert('File uploaded successfully (' + data + ')')
          });
          //.error(...)
          //.then(success, error, progress); 
      }
    })

    thx_app.controller('thx_sub_controller', function($scope, $http, thx_util) {
      $scope.timestamp = 'n/a'
      $scope.thx_controller_test = 'thx_controller_test_value'

      $scope.selectSubscription = function (sub) {
        console.log('selectSubscription')
        console.log(sub)
        $scope.selectedSub = JSON.stringify(sub)
        //$scope.selectedSub = sub
      }

      $scope.getSubscriptions = function () {
        if (/\d{13}/.test($scope.subscriber)) {
          //$http.get(thx_util.sub_url, { 
          $http.jsonp('http://plt-gdsn01.itradenetwork.com:8080/gdsn-server/api/getSubscriptionList' + '?callback=JSON_CALLBACK' , {
            params: { subscriber: $scope.subscriber }
          })
          .success(function (data) {
            $scope.data = data
            $scope.timestamp = data.timestamp
            $scope.selectedSub = null
          })
          .error(function () {
            console.log(arguments)
          })
        }
        else {
          alert('Error: invalid gln, should be 13 digits')
        }
      }

    })

    thx_app.controller('thx_pub_controller', function($scope, $http, thx_util) {
      $scope.timestamp = 'n/a'
      $scope.thx_controller_test = 'thx_controller_test_value'

      $scope.showPubDetail = function (pub) {
        console.log('showPubDetail')
        console.log(pub)
        $scope.selectedPub = JSON.stringify(pub)
        //$scope.selectedPub = pub
      }

      $scope.getPublications = function (pubGln) {
        //$http.get(thx_util.pub_url, { 
        $http.jsonp('http://plt-gdsn01.itradenetwork.com:8080/gdsn-server/api/getPublicationList' + '?callback=JSON_CALLBACK' , {
          params: { publisher: pubGln }
        })
        .success(function (data) {
          $scope.data = data
          $scope.timestamp = data.timestamp
          $scope.selectedPub = null
        })
        .error(function () {
          console.log(arguments)
        })
      }

      $scope.publish_item = function () {
        $('#api_result').hide()
        var data = $('#form_publish').serialize()
        console.log('publishing item with data: ' + data)
        $.ajax({
            dataType: 'json',
            url: app.api + '/publish?' + data
        })
        .done(function (msg, status) {
          alert('API Publish operation complete: ' + status)
          console.log('API Publish operation complete: ' + status)
          $result.append('<div>Result: ' + status + '</div>')
          $result.show().on('click', function () {
            $(this).hide()
          })
        })
        .fail(function () {
            console.log('ajax fail: ' + arguments)
        })
      }

    })

    thx_app.controller('thx_msg_controller', function($scope, $http, thx_util) {

      $scope.post_msg = function () {
        $http.post(thx_util.msg_url, $scope.msg_content_post + '\n\n')
        .success(function (data) {
          console.log(data)
        })
        .error(function () {
          console.log(arguments)
        })
      }

      $scope.list_msg = function () {
        $('#message_list').load(thx_util.msg_url)
      }

      $scope.view_msg = function () {
        $('#msg_content_view').load(thx_util.msg_url + '/' + $scope.view_msg_id)
      }

    })

    thx_app.controller('thx_item_controller', function($scope, $http, thx_util) {

      $scope.showItemDetail = function (item) {
        console.log('showItemDetail called')
        console.log(item.xml)

        item.xml_link = thx_util.getItemUrl(item)
        $scope.selectedItem = item
        //$accordion_item.accordion("option", "active", 1) // activate fold#2 (view item)
        //$scope.input_item_gtin = item.gtin
        //$scope.view_catalog_item()
      }

      $scope.list_items = function () {
        console.log('list_items called')
        showBusy('Fetching item list...')
        //$http.jsonp(thx_util.item_url + '?callback=JSON_CALLBACK' , {
        $http.get(thx_util.item_url, { 
          params: { test_ts: Date.now() }
        })
        .success(function (items) {
          $scope.items = _.map(items, function (item) {
            item.created_ts = (new Date(item.created_ts)).toLocaleString()
            item.modified_ts = (new Date(item.modified_ts)).toLocaleString()
            return item
          })
          $scope.selectedItem = null
          hideBusy()
        })
        .error(function () {
          console.log(arguments)
          hideBusy()
        })
      }

      $scope.post_catalog_items = function () {
        $http.post(thx_util.item_url, $scope.item_content_post + '\n\n')
        .success(function (data) {
          console.log(data)
          alert('XML uploaded successfully (' + data + ')')
        })
        .error(function () {
          console.log(arguments)
        })
      }

      $scope.view_catalog_item = function () {
        $('#item_content_view').load(thx_util.item_url + '/' + $scope.input_item_gtin)
      }

    })

    thx_app.directive('gdsnSubscriptions', function (thx_util) {
      console.log('directive gdsnSubscriptions')
      return {
        restrict: 'EA'
        , replace: true
        , templateUrl: 'gdsn_sub_list_template.html'
        //, scope: { test_ts: '=timestamp' }
        //, scope: false // default; uses enclosing controller scope
        , scope: true // can read enclosing controller scope, not only set local dir scope (can still set scope.$parent)
        , link: function (scope, element, attrs) {
            console.log('link')
            console.log('link attrs')
            console.log(attrs)

            //scope.$parent.subscriber = element.attr('default-subscriber')

            scope.$parent.subscriber = attrs.defaultSubscriber
            console.log('scope.subscriber ' + scope.subscriber)
            scope.dir_link_test = 'dir_link_test_value'

            console.log('scope')
            console.log(scope)
          }
        , controller: function ($scope) {
            $scope.dir_controller_test = 'dir_controller_test_value'
          }
      }
    })
  })()
</script>
<script>
  //$(function () {
  (function () {

    $('#welcome').load('welcome.html')
    $('#find_not_pub').load('find_not_published.html')

    if (app.debug) {
      $('#debug_tab').append('<div>Timestamp: ' + app.ts + '</div>')
      $('#tabs ul').append('<li><a href="#debug_tab">Debug</a></li>')
      $('#snoop').load('snoop')
    }

    $('#tabs').tabs() //{ collapsible: true, active: false })

    var tab_names = {
      main  : 0, 
      msg   : 1, 
      items : 2, 
      pub   : 3, 
      sub   : 4, 
      debug : 5
    }
    $("#tabs").tabs("option", "active", tab_names['items']) 

    $('#progressbar').progressbar({ value: false })

    $('#api_result').hide()

  })()
</script>
</body>
</html>
